#!/bin/sh
# Pre-commit hook –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è —Å–ª—É—á–∞–π–Ω–æ–≥–æ –∫–æ–º–º–∏—Ç–∞ .env —Ñ–∞–π–ª–æ–≤ –∏ API –∫–ª—é—á–µ–π
# –£—Å—Ç–∞–Ω–æ–≤–∫–∞: cp .githooks/pre-commit .git/hooks/pre-commit && chmod +x .git/hooks/pre-commit

set -e

RED='\033[0;31m'
YELLOW='\033[1;33m'
GREEN='\033[0;32m'
NC='\033[0m' # No Color

STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM)

# –ü—Ä–æ–≤–µ—Ä–∫–∞ 1: .env —Ñ–∞–π–ª—ã
echo "${YELLOW}üîç Checking for .env files...${NC}"
if echo "$STAGED_FILES" | grep -E '\.env\.local|\.env\..+\.local|backend/\.env|frontend/\.env' > /dev/null 2>&1; then
    echo "${RED}‚ùå ERROR: You're trying to commit .env files!${NC}"
    echo "${RED}   These files contain secrets and should never be committed.${NC}"
    echo ""
    echo "${YELLOW}   Files to unstage:${NC}"
    echo "$STAGED_FILES" | grep -E '\.env' | sed 's/^/     /'
    echo ""
    echo "${YELLOW}   To fix:${NC}"
    echo "     git reset HEAD <filename>"
    echo "     git checkout <filename>"
    echo ""
    exit 1
fi

# –ü—Ä–æ–≤–µ—Ä–∫–∞ 2: API –∫–ª—é—á–∏ –≤ –∫–æ–¥–µ
echo "${YELLOW}üîç Checking for API keys in staged files...${NC}"

SECRETS_FOUND=0

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ OpenAI –∫–ª—é—á–∏
if git diff --cached | grep -E 'sk-proj-[a-zA-Z0-9_-]{40,}|sk-[a-zA-Z0-9]{20,}' > /dev/null 2>&1; then
    echo "${RED}‚ùå ERROR: OpenAI API key found in staged changes!${NC}"
    SECRETS_FOUND=1
fi

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ Google API –∫–ª—é—á–∏ (AIzaSy...)
if git diff --cached | grep -E 'AIzaSy[a-zA-Z0-9_-]{35,}' > /dev/null 2>&1; then
    echo "${RED}‚ùå ERROR: Google API key found in staged changes!${NC}"
    SECRETS_FOUND=1
fi

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ Database –ø–∞—Ä–æ–ª–∏
if git diff --cached | grep -iE '(password|secret|token).*=' | grep -v '\.example' > /dev/null 2>&1; then
    echo "${RED}‚ùå ERROR: Possible hardcoded password/token found!${NC}"
    SECRETS_FOUND=1
fi

if [ $SECRETS_FOUND -eq 1 ]; then
    echo ""
    echo "${YELLOW}   To see the diff:${NC}"
    echo "     git diff --cached"
    echo ""
    echo "${YELLOW}   To reset specific file:${NC}"
    echo "     git reset HEAD <filename>"
    echo ""
    echo "${YELLOW}   To see which lines have secrets:${NC}"
    echo "     git diff --cached | grep -E '(sk-|AIzaSy|password)'"
    echo ""
    exit 1
fi

echo "${GREEN}‚úÖ All checks passed!${NC}"
exit 0
