#!/bin/bash
# –°–∫—Ä–∏–ø—Ç –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è OpenAI API –∫–ª—é—á–∞ –≤ .env

set -e

cd ~/Izborator

echo "üîë –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ OpenAI API –∫–ª—é—á–∞ –≤ .env"
echo "=========================================="
echo ""

# –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ .env
if [ ! -f .env ]; then
  echo "‚ùå –§–∞–π–ª .env –Ω–µ –Ω–∞–π–¥–µ–Ω!"
  exit 1
fi

# –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–µ–∫—É—â–∏–π –∫–ª—é—á (–ø–µ—Ä–≤—ã–µ –∏ –ø–æ—Å–ª–µ–¥–Ω–∏–µ —Å–∏–º–≤–æ–ª—ã)
if grep -q "OPENAI_API_KEY=" .env; then
  CURRENT_KEY=$(grep "^OPENAI_API_KEY=" .env | cut -d'=' -f2- | tr -d '[:space:]')
  if [ -n "$CURRENT_KEY" ]; then
    echo "üìã –¢–µ–∫—É—â–∏–π –∫–ª—é—á –≤ .env:"
    echo "   –ù–∞—á–∏–Ω–∞–µ—Ç—Å—è —Å: ${CURRENT_KEY:0:15}..."
    echo "   –ó–∞–∫–∞–Ω—á–∏–≤–∞–µ—Ç—Å—è –Ω–∞: ...${CURRENT_KEY: -4}"
    echo "   –î–ª–∏–Ω–∞: ${#CURRENT_KEY} —Å–∏–º–≤–æ–ª–æ–≤"
    echo ""
  fi
fi

echo "üìù –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è:"
echo "   1. –û—Ç–∫—Ä–æ–π https://platform.openai.com/account/api-keys"
echo "   2. –ù–∞–π–¥–∏ –°–ê–ú–´–ô –ù–û–í–´–ô –∫–ª—é—á (—Ç–æ–ª—å–∫–æ —á—Ç–æ —Å–æ–∑–¥–∞–Ω–Ω—ã–π)"
echo "   3. –ù–∞–∂–º–∏ –Ω–∞ –∫–ª—é—á, —á—Ç–æ–±—ã —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –µ–≥–æ –ü–û–õ–ù–û–°–¢–¨–Æ"
echo "   4. –í—Å—Ç–∞–≤—å –Ω–æ–≤—ã–π –∫–ª—é—á –Ω–∏–∂–µ (Ctrl+Shift+V –∏–ª–∏ –ø—Ä–∞–≤–∞—è –∫–Ω–æ–ø–∫–∞ –º—ã—à–∏)"
echo ""
echo "‚ö†Ô∏è  –í–ê–ñ–ù–û: –°–∫–æ–ø–∏—Ä—É–π –∫–ª—é—á –ü–û–õ–ù–û–°–¢–¨–Æ (–æ–±—ã—á–Ω–æ 200+ —Å–∏–º–≤–æ–ª–æ–≤)"
echo ""

# –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –Ω–æ–≤—ã–π –∫–ª—é—á
read -p "–í—Å—Ç–∞–≤—å –Ω–æ–≤—ã–π OpenAI API –∫–ª—é—á: " NEW_KEY

# –£–¥–∞–ª—è–µ–º –ø—Ä–æ–±–µ–ª—ã –∏ –ø–µ—Ä–µ–Ω–æ—Å—ã —Å—Ç—Ä–æ–∫
CLEAN_NEW_KEY=$(echo "$NEW_KEY" | tr -d '[:space:]')

# –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ñ–æ—Ä–º–∞—Ç
if [ -z "$CLEAN_NEW_KEY" ]; then
  echo "‚ùå –ö–ª—é—á –ø—É—Å—Ç–æ–π!"
  exit 1
fi

if [[ ! "$CLEAN_NEW_KEY" =~ ^sk- ]]; then
  echo "‚ö†Ô∏è  –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ: –ö–ª—é—á –Ω–µ –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è —Å 'sk-'"
  read -p "–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å? (y/n): " CONFIRM
  if [ "$CONFIRM" != "y" ]; then
    echo "–û—Ç–º–µ–Ω–µ–Ω–æ"
    exit 1
  fi
fi

echo ""
echo "üìã –ù–æ–≤—ã–π –∫–ª—é—á:"
echo "   –ù–∞—á–∏–Ω–∞–µ—Ç—Å—è —Å: ${CLEAN_NEW_KEY:0:15}..."
echo "   –ó–∞–∫–∞–Ω—á–∏–≤–∞–µ—Ç—Å—è –Ω–∞: ...${CLEAN_NEW_KEY: -4}"
echo "   –î–ª–∏–Ω–∞: ${#CLEAN_NEW_KEY} —Å–∏–º–≤–æ–ª–æ–≤"
echo ""

read -p "–û–±–Ω–æ–≤–∏—Ç—å .env —Å —ç—Ç–∏–º –∫–ª—é—á–æ–º? (y/n): " CONFIRM
if [ "$CONFIRM" != "y" ]; then
  echo "–û—Ç–º–µ–Ω–µ–Ω–æ"
  exit 0
fi

# –°–æ–∑–¥–∞–µ–º —Ä–µ–∑–µ—Ä–≤–Ω—É—é –∫–æ–ø–∏—é
cp .env .env.backup.$(date +%Y%m%d_%H%M%S)
echo "‚úÖ –°–æ–∑–¥–∞–Ω–∞ —Ä–µ–∑–µ—Ä–≤–Ω–∞—è –∫–æ–ø–∏—è: .env.backup.*"

# –û–±–Ω–æ–≤–ª—è–µ–º –∫–ª—é—á –≤ .env
if grep -q "^OPENAI_API_KEY=" .env; then
  # –ó–∞–º–µ–Ω—è–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –∫–ª—é—á
  sed -i "s|^OPENAI_API_KEY=.*|OPENAI_API_KEY=$CLEAN_NEW_KEY|" .env
else
  # –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—ã–π –∫–ª—é—á
  echo "OPENAI_API_KEY=$CLEAN_NEW_KEY" >> .env
fi

echo "‚úÖ .env –æ–±–Ω–æ–≤–ª–µ–Ω!"
echo ""
echo "üß™ –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–ª—é—á..."
export OPENAI_API_KEY="$CLEAN_NEW_KEY"

RESPONSE=$(curl -s -w "\n%{http_code}" \
  -H "Authorization: Bearer $CLEAN_NEW_KEY" \
  -H "Content-Type: application/json" \
  https://api.openai.com/v1/models 2>&1)

HTTP_CODE=$(echo "$RESPONSE" | tail -n1)

if [ "$HTTP_CODE" = "200" ]; then
  echo "‚úÖ –ö–ª—é—á –≤–∞–ª–∏–¥–µ–Ω! API –æ—Ç–≤–µ—á–∞–µ—Ç —É—Å–ø–µ—à–Ω–æ"
  echo ""
  echo "üéâ –ì–æ—Ç–æ–≤–æ! –¢–µ–ø–µ—Ä—å –º–æ–∂–Ω–æ –∑–∞–ø—É—Å—Ç–∏—Ç—å AutoConfig:"
  echo "   ./run-autoconfig-server.sh"
elif [ "$HTTP_CODE" = "401" ]; then
  echo "‚ùå –û—à–∏–±–∫–∞ 401: –ö–ª—é—á –≤—Å–µ –µ—â–µ –Ω–µ–≤–µ—Ä–Ω—ã–π"
  echo ""
  echo "‚ö†Ô∏è  –í–æ–∑–º–æ–∂–Ω—ã–µ –ø—Ä–∏—á–∏–Ω—ã:"
  echo "   1. –ö–ª—é—á —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω –Ω–µ –ø–æ–ª–Ω–æ—Å—Ç—å—é"
  echo "   2. –ö–ª—é—á –µ—â–µ –Ω–µ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω (–ø–æ–¥–æ–∂–¥–∏ 1-2 –º–∏–Ω—É—Ç—ã)"
  echo "   3. –ù–µ–≤–µ—Ä–Ω—ã–π –∫–ª—é—á"
  echo ""
  echo "üí° –ü–æ–ø—Ä–æ–±—É–π:"
  echo "   1. –ü—Ä–æ–≤–µ—Ä—å –∫–ª—é—á –Ω–∞ platform.openai.com"
  echo "   2. –£–±–µ–¥–∏—Å—å, —á—Ç–æ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–ª –∫–ª—é—á –ü–û–õ–ù–û–°–¢–¨–Æ"
  echo "   3. –ó–∞–ø—É—Å—Ç–∏ —ç—Ç–æ—Ç —Å–∫—Ä–∏–ø—Ç —Å–Ω–æ–≤–∞"
else
  echo "‚ö†Ô∏è  –ù–µ–æ–∂–∏–¥–∞–Ω–Ω—ã–π –æ—Ç–≤–µ—Ç: HTTP $HTTP_CODE"
fi

