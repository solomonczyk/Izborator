name: Run Harvest (Project Horizon)

on:
  workflow_dispatch: # ÐŸÐ¾Ð·Ð²Ð¾Ð»ÑÐµÑ‚ Ð·Ð°Ð¿ÑƒÑÐºÐ°Ñ‚ÑŒ Ð²Ñ€ÑƒÑ‡Ð½ÑƒÑŽ
  push:
    branches:
      - main
    paths:
      - '.github/workflows/run-harvest.yml'
      - 'run-harvest.sh'

jobs:
  harvest:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}
        
      - name: Add server to known hosts
        run: |
          ssh-keyscan -H ${{ secrets.SERVER_HOST }} >> ~/.ssh/known_hosts

      - name: Run Harvest (Discovery â†’ Classifier â†’ AutoConfig)
        run: |
          ssh root@${{ secrets.SERVER_HOST }} << 'EOF'
            set -e
            cd ~/Izborator
            
            echo "ðŸ­ Project Horizon - Ð—Ð°Ð¿ÑƒÑÐº 'Ð¤Ð°Ð±Ñ€Ð¸ÐºÐ¸'"
            echo "======================================"
            echo ""
            
            # Ð—Ð°Ð³Ñ€ÑƒÐ¶Ð°ÐµÐ¼ Ð¿ÐµÑ€ÐµÐ¼ÐµÐ½Ð½Ñ‹Ðµ Ð¸Ð· .env
            if [ -f .env ]; then
              export $(cat .env | grep -v '^#' | xargs)
            fi
            
            # Ð¨Ð°Ð³ 1: Discovery
            echo "ðŸ” Ð¨Ð°Ð³ 1: Discovery (Ð¿Ð¾Ð¸ÑÐº ÐºÐ°Ð½Ð´Ð¸Ð´Ð°Ñ‚Ð¾Ð²)..."
            docker-compose run --rm \
              -e GOOGLE_API_KEY="${GOOGLE_API_KEY}" \
              -e GOOGLE_CX="${GOOGLE_CX}" \
              backend ./discovery || echo "âš ï¸  Discovery Ð·Ð°Ð²ÐµÑ€ÑˆÐ¸Ð»ÑÑ Ñ Ð¿Ñ€ÐµÐ´ÑƒÐ¿Ñ€ÐµÐ¶Ð´ÐµÐ½Ð¸ÑÐ¼Ð¸"
            echo "âœ… Discovery Ð·Ð°Ð²ÐµÑ€ÑˆÐµÐ½"
            echo ""
            
            sleep 2
            
            # Ð¨Ð°Ð³ 2: Classifier
            echo "ðŸ” Ð¨Ð°Ð³ 2: Classifier (ÐºÐ»Ð°ÑÑÐ¸Ñ„Ð¸ÐºÐ°Ñ†Ð¸Ñ)..."
            docker-compose run --rm backend ./classifier -classify-all || echo "âš ï¸  Classifier Ð·Ð°Ð²ÐµÑ€ÑˆÐ¸Ð»ÑÑ Ñ Ð¿Ñ€ÐµÐ´ÑƒÐ¿Ñ€ÐµÐ¶Ð´ÐµÐ½Ð¸ÑÐ¼Ð¸"
            
            CLASSIFIED_COUNT=$(docker-compose exec -T postgres psql -U postgres -d izborator -t -c "SELECT COUNT(*) FROM potential_shops WHERE status = 'classified';" | tr -d ' ')
            echo "âœ… ÐšÐ»Ð°ÑÑÐ¸Ñ„Ð¸Ñ†Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¾ Ð¼Ð°Ð³Ð°Ð·Ð¸Ð½Ð¾Ð²: $CLASSIFIED_COUNT"
            echo ""
            
            if [ "$CLASSIFIED_COUNT" -eq "0" ]; then
              echo "âš ï¸  ÐÐµÑ‚ ÐºÐ»Ð°ÑÑÐ¸Ñ„Ð¸Ñ†Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð½Ñ‹Ñ… Ð¼Ð°Ð³Ð°Ð·Ð¸Ð½Ð¾Ð² Ð´Ð»Ñ AutoConfig"
              exit 0
            fi
            
            # Ð¨Ð°Ð³ 3: AutoConfig
            echo "ðŸ¤– Ð¨Ð°Ð³ 3: AutoConfig (AI Ð³ÐµÐ½ÐµÑ€Ð°Ñ†Ð¸Ñ ÑÐµÐ»ÐµÐºÑ‚Ð¾Ñ€Ð¾Ð²)..."
            echo "ÐžÐ±Ñ€Ð°Ð±Ð°Ñ‚Ñ‹Ð²Ð°ÐµÐ¼ 5 Ð¼Ð°Ð³Ð°Ð·Ð¸Ð½Ð¾Ð²..."
            docker-compose run --rm \
              -e OPENAI_API_KEY="${OPENAI_API_KEY}" \
              -e OPENAI_MODEL="${OPENAI_MODEL:-gpt-4o-mini}" \
              backend ./autoconfig -limit 5 || echo "âš ï¸  AutoConfig Ð·Ð°Ð²ÐµÑ€ÑˆÐ¸Ð»ÑÑ Ñ Ð¿Ñ€ÐµÐ´ÑƒÐ¿Ñ€ÐµÐ¶Ð´ÐµÐ½Ð¸ÑÐ¼Ð¸"
            echo "âœ… AutoConfig Ð·Ð°Ð²ÐµÑ€ÑˆÐµÐ½"
            echo ""
            
            # Ð¨Ð°Ð³ 4: ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ñ€ÐµÐ·ÑƒÐ»ÑŒÑ‚Ð°Ñ‚Ð¾Ð²
            echo "ðŸ“Š Ð¨Ð°Ð³ 4: ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ñ€ÐµÐ·ÑƒÐ»ÑŒÑ‚Ð°Ñ‚Ð¾Ð²..."
            echo ""
            echo "Ð¡Ð¾Ð·Ð´Ð°Ð½Ð½Ñ‹Ðµ Ð¼Ð°Ð³Ð°Ð·Ð¸Ð½Ñ‹ (AutoConfig):"
            docker-compose exec -T postgres psql -U postgres -d izborator -c "
              SELECT 
                  name, 
                  base_url, 
                  is_active,
                  is_auto_configured,
                  ai_config_model,
                  created_at
              FROM shops 
              WHERE is_auto_configured = true 
              ORDER BY created_at DESC
              LIMIT 10;
            " || echo "âš ï¸  ÐÐµ ÑƒÐ´Ð°Ð»Ð¾ÑÑŒ Ð¿Ð¾Ð»ÑƒÑ‡Ð¸Ñ‚ÑŒ Ñ€ÐµÐ·ÑƒÐ»ÑŒÑ‚Ð°Ñ‚Ñ‹"
            
            echo ""
            echo "Ð¡Ñ‚Ð°Ñ‚Ð¸ÑÑ‚Ð¸ÐºÐ° Ð¿Ð¾ ÑÑ‚Ð°Ñ‚ÑƒÑÐ°Ð¼:"
            docker-compose exec -T postgres psql -U postgres -d izborator -c "
              SELECT 
                  status,
                  COUNT(*) as count
              FROM potential_shops
              GROUP BY status
              ORDER BY status;
            " || echo "âš ï¸  ÐÐµ ÑƒÐ´Ð°Ð»Ð¾ÑÑŒ Ð¿Ð¾Ð»ÑƒÑ‡Ð¸Ñ‚ÑŒ ÑÑ‚Ð°Ñ‚Ð¸ÑÑ‚Ð¸ÐºÑƒ"
            
            echo ""
            echo "âœ… 'Ð¤Ð°Ð±Ñ€Ð¸ÐºÐ°' Ð·Ð°Ð²ÐµÑ€ÑˆÐ¸Ð»Ð° Ñ€Ð°Ð±Ð¾Ñ‚Ñƒ!"
          EOF

      - name: Notify completion
        if: always()
        run: |
          if [ "${{ job.status }}" == "success" ]; then
            echo "âœ… Harvest completed successfully!"
          else
            echo "âŒ Harvest completed with errors!"
          fi

