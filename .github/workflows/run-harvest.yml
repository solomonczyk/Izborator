name: Run Harvest (Project Horizon)

on:
  workflow_dispatch: # –ü–æ–∑–≤–æ–ª—è–µ—Ç –∑–∞–ø—É—Å–∫–∞—Ç—å –≤—Ä—É—á–Ω—É—é
  push:
    branches:
      - main
    paths:
      - '.github/workflows/run-harvest.yml'
      - 'run-harvest.sh'
      - '.trigger-harvest'

jobs:
  harvest:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}
        
      - name: Add server to known hosts
        run: |
          ssh-keyscan -H ${{ secrets.SERVER_HOST }} >> ~/.ssh/known_hosts

      - name: Run Harvest (Fix + Discovery ‚Üí Classifier ‚Üí AutoConfig)
        run: |
          ssh root@${{ secrets.SERVER_HOST }} << 'EOF'
            set -e
            cd ~/Izborator
            
            echo "üè≠ Project Horizon - –ó–∞–ø—É—Å–∫ '–§–∞–±—Ä–∏–∫–∏' (—Å –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è–º–∏)"
            echo "========================================================"
            echo ""
            
            # –®–∞–≥ 0: –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –º–∏–≥—Ä–∞—Ü–∏–π
            echo "üì¶ –®–∞–≥ 0: –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –º–∏–≥—Ä–∞—Ü–∏–π..."
            docker-compose run --rm backend ./migrate 2>&1 | tail -5 || echo "‚ö†Ô∏è  –ú–∏–≥—Ä–∞—Ü–∏–∏ —É–∂–µ –ø—Ä–∏–º–µ–Ω–µ–Ω—ã –∏–ª–∏ –æ—à–∏–±–∫–∞"
            echo ""
            
            # –ó–∞–≥—Ä—É–∂–∞–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –∏–∑ .env
            if [ -f .env ]; then
              export $(cat .env | grep -v '^#' | xargs)
              echo "‚úÖ –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è –∑–∞–≥—Ä—É–∂–µ–Ω—ã"
            else
              echo "‚ö†Ô∏è  –§–∞–π–ª .env –Ω–µ –Ω–∞–π–¥–µ–Ω"
            fi
            echo ""
            
            # –®–∞–≥ 1: Discovery (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ, –µ—Å–ª–∏ –Ω–µ—Ç –∫–∞–Ω–¥–∏–¥–∞—Ç–æ–≤)
            NEW_COUNT=$(docker-compose exec -T postgres psql -U postgres -d izborator -t -c "SELECT COUNT(*) FROM potential_shops WHERE status = 'new';" | tr -d ' ')
            if [ "$NEW_COUNT" -eq "0" ]; then
              echo "üîç –®–∞–≥ 1: Discovery (–ø–æ–∏—Å–∫ –∫–∞–Ω–¥–∏–¥–∞—Ç–æ–≤)..."
              docker-compose run --rm \
                -e GOOGLE_API_KEY="${GOOGLE_API_KEY}" \
                -e GOOGLE_CX="${GOOGLE_CX}" \
                backend ./discovery || echo "‚ö†Ô∏è  Discovery –∑–∞–≤–µ—Ä—à–∏–ª—Å—è —Å –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è–º–∏"
              echo "‚úÖ Discovery –∑–∞–≤–µ—Ä—à–µ–Ω"
              echo ""
              sleep 2
            else
              echo "‚úÖ –£–∂–µ –µ—Å—Ç—å $NEW_COUNT –∫–∞–Ω–¥–∏–¥–∞—Ç–æ–≤ —Å–æ —Å—Ç–∞—Ç—É—Å–æ–º 'new', –ø—Ä–æ–ø—É—Å–∫–∞–µ–º Discovery"
              echo ""
            fi
            
            # –®–∞–≥ 2: Classifier
            echo "üîç –®–∞–≥ 2: Classifier (–∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏—è –≤—Å–µ—Ö –∫–∞–Ω–¥–∏–¥–∞—Ç–æ–≤)..."
            docker-compose run --rm backend ./classifier -classify-all || echo "‚ö†Ô∏è  Classifier –∑–∞–≤–µ—Ä—à–∏–ª—Å—è —Å –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è–º–∏"
            echo ""
            
            CLASSIFIED_COUNT=$(docker-compose exec -T postgres psql -U postgres -d izborator -t -c "SELECT COUNT(*) FROM potential_shops WHERE status = 'classified';" | tr -d ' ')
            echo "‚úÖ –ö–ª–∞—Å—Å–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–æ –º–∞–≥–∞–∑–∏–Ω–æ–≤: $CLASSIFIED_COUNT"
            echo ""
            
            # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
            echo "üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ —Å—Ç–∞—Ç—É—Å–∞–º –ø–æ—Å–ª–µ Classifier:"
            docker-compose exec -T postgres psql -U postgres -d izborator -c "
              SELECT 
                  status,
                  COUNT(*) as count
              FROM potential_shops
              GROUP BY status
              ORDER BY status;
            " || echo "‚ö†Ô∏è  –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É"
            echo ""
            
            if [ "$CLASSIFIED_COUNT" -eq "0" ]; then
              echo "‚ö†Ô∏è  –ù–µ—Ç –∫–ª–∞—Å—Å–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –º–∞–≥–∞–∑–∏–Ω–æ–≤ –¥–ª—è AutoConfig"
              echo "–ü—Ä–æ–≤–µ—Ä—å –ª–æ–≥–∏ Classifier –≤—ã—à–µ"
              exit 0
            fi
            
            # –®–∞–≥ 3: AutoConfig
            echo "ü§ñ –®–∞–≥ 3: AutoConfig (AI –≥–µ–Ω–µ—Ä–∞—Ü–∏—è —Å–µ–ª–µ–∫—Ç–æ—Ä–æ–≤)..."
            echo "–û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º 5 –º–∞–≥–∞–∑–∏–Ω–æ–≤..."
            docker-compose run --rm \
              -e OPENAI_API_KEY="${OPENAI_API_KEY}" \
              -e OPENAI_MODEL="${OPENAI_MODEL:-gpt-4o-mini}" \
              backend ./autoconfig -limit 5 || echo "‚ö†Ô∏è  AutoConfig –∑–∞–≤–µ—Ä—à–∏–ª—Å—è —Å –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è–º–∏"
            echo "‚úÖ AutoConfig –∑–∞–≤–µ—Ä—à–µ–Ω"
            echo ""
            
            # –®–∞–≥ 4: –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
            echo "üìä –®–∞–≥ 4: –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤..."
            echo ""
            echo "–°–æ–∑–¥–∞–Ω–Ω—ã–µ –º–∞–≥–∞–∑–∏–Ω—ã (AutoConfig):"
            docker-compose exec -T postgres psql -U postgres -d izborator -c "
              SELECT 
                  name, 
                  base_url, 
                  is_active,
                  is_auto_configured,
                  ai_config_model,
                  selectors->>'name' as name_selector,
                  selectors->>'price' as price_selector,
                  created_at
              FROM shops 
              WHERE is_auto_configured = true 
              ORDER BY created_at DESC
              LIMIT 10;
            " || echo "‚ö†Ô∏è  –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã"
            
            echo ""
            echo "–§–∏–Ω–∞–ª—å–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ —Å—Ç–∞—Ç—É—Å–∞–º:"
            docker-compose exec -T postgres psql -U postgres -d izborator -c "
              SELECT 
                  status,
                  COUNT(*) as count
              FROM potential_shops
              GROUP BY status
              ORDER BY status;
            " || echo "‚ö†Ô∏è  –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É"
            
            echo ""
            echo "‚úÖ '–§–∞–±—Ä–∏–∫–∞' –∑–∞–≤–µ—Ä—à–∏–ª–∞ —Ä–∞–±–æ—Ç—É!"
          EOF

      - name: Notify completion
        if: always()
        run: |
          if [ "${{ job.status }}" == "success" ]; then
            echo "‚úÖ Harvest completed successfully!"
          else
            echo "‚ùå Harvest completed with errors!"
          fi

