name: Verify Migrations & Run Pipeline

on:
  workflow_dispatch:
  push:
    branches:
      - main
    paths:
      - '.github/workflows/verify-and-run-pipeline.yml'
      - '.trigger-verify-run'

jobs:
  verify-and-run:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}
        
      - name: Add server to known hosts
        run: |
          ssh-keyscan -H ${{ secrets.SERVER_HOST }} >> ~/.ssh/known_hosts

      - name: Verify Migrations & Run Full Pipeline
        run: |
          ssh root@${{ secrets.SERVER_HOST }} << 'EOF'
            set +e
            cd ~/Izborator
            git pull || true
            
            echo "üîç –®–∞–≥ 1: –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è –º–∏–≥—Ä–∞—Ü–∏–π..."
            docker-compose exec -T postgres psql -U postgres -d izborator -c "
              SELECT version, dirty FROM schema_migrations;
            " || echo "‚ö†Ô∏è  –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å —Å—Ç–∞—Ç—É—Å"
            echo ""
            
            echo "‚úÖ –®–∞–≥ 2: –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–∞–±–ª–∏—Ü—ã shop_config_attempts..."
            if docker-compose exec -T postgres psql -U postgres -d izborator -c "\d shop_config_attempts" > /dev/null 2>&1; then
              echo "‚úÖ –¢–∞–±–ª–∏—Ü–∞ shop_config_attempts —Å—É—â–µ—Å—Ç–≤—É–µ—Ç"
            else
              echo "‚ùå –¢–∞–±–ª–∏—Ü–∞ shop_config_attempts –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç - –ø—Ä–∏–º–µ–Ω—è–µ–º –º–∏–≥—Ä–∞—Ü–∏–∏..."
              docker-compose run --rm backend ./migrate 2>&1 | tail -10
            fi
            echo ""
            
            echo "üìä –®–∞–≥ 3: –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ potential_shops..."
            docker-compose exec -T postgres psql -U postgres -d izborator -c "
              SELECT 
                  status,
                  COUNT(*) as count
              FROM potential_shops
              GROUP BY status
              ORDER BY status;
            "
            echo ""
            
            # –ó–∞–≥—Ä—É–∂–∞–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è
            if [ -f .env ]; then
              export $(cat .env | grep -v '^#' | xargs)
              echo "‚úÖ –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è –∑–∞–≥—Ä—É–∂–µ–Ω—ã"
            else
              echo "‚ùå –§–∞–π–ª .env –Ω–µ –Ω–∞–π–¥–µ–Ω"
              exit 1
            fi
            echo ""
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –∫–∞–Ω–¥–∏–¥–∞—Ç—ã –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏
            NEW_COUNT=$(docker-compose exec -T postgres psql -U postgres -d izborator -t -c "SELECT COUNT(*) FROM potential_shops WHERE status = 'new';" | tr -d ' ')
            CLASSIFIED_COUNT=$(docker-compose exec -T postgres psql -U postgres -d izborator -t -c "SELECT COUNT(*) FROM potential_shops WHERE status = 'classified';" | tr -d ' ')
            
            echo "üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞: new=$NEW_COUNT, classified=$CLASSIFIED_COUNT"
            echo ""
            
            # –ó–∞–ø—É—Å–∫–∞–µ–º Classifier, –µ—Å–ª–∏ –µ—Å—Ç—å new –∫–∞–Ω–¥–∏–¥–∞—Ç—ã
            if [ "$NEW_COUNT" -gt "0" ]; then
              echo "üîç –®–∞–≥ 4: –ó–∞–ø—É—Å–∫ Classifier..."
              docker-compose run --rm backend ./classifier -classify-all 2>&1 | tee /tmp/classifier.log
              echo ""
              
              # –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
              CLASSIFIED_COUNT=$(docker-compose exec -T postgres psql -U postgres -d izborator -t -c "SELECT COUNT(*) FROM potential_shops WHERE status = 'classified';" | tr -d ' ')
              echo "‚úÖ –ü–æ—Å–ª–µ Classifier: classified=$CLASSIFIED_COUNT"
              echo ""
            else
              echo "‚úÖ –ù–µ—Ç –Ω–æ–≤—ã—Ö –∫–∞–Ω–¥–∏–¥–∞—Ç–æ–≤ –¥–ª—è Classifier"
              echo ""
            fi
            
            # –ó–∞–ø—É—Å–∫–∞–µ–º AutoConfig, –µ—Å–ª–∏ –µ—Å—Ç—å classified –∫–∞–Ω–¥–∏–¥–∞—Ç—ã
            if [ "$CLASSIFIED_COUNT" -gt "0" ]; then
              echo "ü§ñ –®–∞–≥ 5: –ó–∞–ø—É—Å–∫ AutoConfig (–æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º 5 –º–∞–≥–∞–∑–∏–Ω–æ–≤)..."
              docker-compose run --rm \
                -e OPENAI_API_KEY="${OPENAI_API_KEY}" \
                -e OPENAI_MODEL="${OPENAI_MODEL:-gpt-4o-mini}" \
                backend ./autoconfig -limit 5 2>&1 | tee /tmp/autoconfig.log
              echo ""
            else
              echo "‚ö†Ô∏è  –ù–µ—Ç classified –º–∞–≥–∞–∑–∏–Ω–æ–≤ –¥–ª—è AutoConfig"
              echo ""
            fi
            
            # –§–∏–Ω–∞–ª—å–Ω—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
            echo "üìä –®–∞–≥ 6: –§–∏–Ω–∞–ª—å–Ω—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã..."
            echo ""
            echo "–°–æ–∑–¥–∞–Ω–Ω—ã–µ –º–∞–≥–∞–∑–∏–Ω—ã (AutoConfig):"
            docker-compose exec -T postgres psql -U postgres -d izborator -c "
              SELECT 
                  name, 
                  base_url, 
                  is_active,
                  is_auto_configured,
                  ai_config_model,
                  created_at
              FROM shops 
              WHERE is_auto_configured = true 
              ORDER BY created_at DESC
              LIMIT 10;
            " || echo "‚ö†Ô∏è  –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã"
            echo ""
            
            echo "–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ —Å—Ç–∞—Ç—É—Å–∞–º potential_shops:"
            docker-compose exec -T postgres psql -U postgres -d izborator -c "
              SELECT 
                  status,
                  COUNT(*) as count
              FROM potential_shops
              GROUP BY status
              ORDER BY status;
            " || echo "‚ö†Ô∏è  –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É"
            echo ""
            
            echo "‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏ –∑–∞–ø—É—Å–∫ –∑–∞–≤–µ—Ä—à–µ–Ω—ã!"
          EOF

