name: Check AutoConfig Results

on:
  workflow_dispatch: # ÐŸÐ¾Ð·Ð²Ð¾Ð»ÑÐµÑ‚ Ð·Ð°Ð¿ÑƒÑÐºÐ°Ñ‚ÑŒ Ð²Ñ€ÑƒÑ‡Ð½ÑƒÑŽ
  schedule:
    # Ð—Ð°Ð¿ÑƒÑÐºÐ°ÐµÑ‚ÑÑ ÐºÐ°Ð¶Ð´Ñ‹Ð¹ Ð´ÐµÐ½ÑŒ Ð² 6:00 UTC (Ð¿Ð¾ÑÐ»Ðµ Ð²Ð¾Ð·Ð¼Ð¾Ð¶Ð½Ð¾Ð³Ð¾ AutoConfig)
    - cron: '0 6 * * *'

jobs:
  check-results:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}
        
      - name: Add server to known hosts
        run: |
          ssh-keyscan -H ${{ secrets.SERVER_HOST }} >> ~/.ssh/known_hosts

      - name: Check AutoConfig Results
        run: |
          ssh root@${{ secrets.SERVER_HOST }} << 'EOF'
            set -e
            cd ~/Izborator
            
            echo "ðŸ” ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ñ€ÐµÐ·ÑƒÐ»ÑŒÑ‚Ð°Ñ‚Ð¾Ð² AutoConfig..."
            echo "=========================================="
            echo ""
            
            # ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð°Ð²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¸ ÑÐ¾Ð·Ð´Ð°Ð½Ð½Ñ‹Ñ… Ð¼Ð°Ð³Ð°Ð·Ð¸Ð½Ð¾Ð²
            echo "ðŸ“Š ÐœÐ°Ð³Ð°Ð·Ð¸Ð½Ñ‹ Ñ is_auto_configured = true:"
            docker exec -i izborator_postgres psql -U postgres -d izborator -c "
            SELECT 
                id,
                name, 
                base_url, 
                is_active, 
                is_auto_configured,
                created_at 
            FROM shops 
            WHERE is_auto_configured = true 
            ORDER BY created_at DESC;
            " || echo "âš ï¸  ÐÐµ ÑƒÐ´Ð°Ð»Ð¾ÑÑŒ Ð¿Ð¾Ð»ÑƒÑ‡Ð¸Ñ‚ÑŒ Ð´Ð°Ð½Ð½Ñ‹Ðµ"
            
            echo ""
            echo "ðŸ“ˆ Ð¡Ñ‚Ð°Ñ‚Ð¸ÑÑ‚Ð¸ÐºÐ° Ð¿Ð¾ Ð¼Ð°Ð³Ð°Ð·Ð¸Ð½Ð°Ð¼:"
            docker exec -i izborator_postgres psql -U postgres -d izborator -c "
            SELECT 
                COUNT(*) FILTER (WHERE is_auto_configured = true) as auto_configured_count,
                COUNT(*) FILTER (WHERE is_auto_configured = false) as manual_count,
                COUNT(*) as total_shops
            FROM shops;
            " || echo "âš ï¸  ÐÐµ ÑƒÐ´Ð°Ð»Ð¾ÑÑŒ Ð¿Ð¾Ð»ÑƒÑ‡Ð¸Ñ‚ÑŒ ÑÑ‚Ð°Ñ‚Ð¸ÑÑ‚Ð¸ÐºÑƒ"
            
            echo ""
            echo "ðŸ”§ ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° shop_config_attempts:"
            docker exec -i izborator_postgres psql -U postgres -d izborator -c "
            SELECT 
                status,
                COUNT(*) as count
            FROM shop_config_attempts
            GROUP BY status
            ORDER BY status;
            " || echo "âš ï¸  ÐÐµ ÑƒÐ´Ð°Ð»Ð¾ÑÑŒ Ð¿Ð¾Ð»ÑƒÑ‡Ð¸Ñ‚ÑŒ Ð´Ð°Ð½Ð½Ñ‹Ðµ"
            
            echo ""
            echo "ðŸ“‹ ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° potential_shops (ÐºÐ»Ð°ÑÑÐ¸Ñ„Ð¸Ñ†Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð½Ñ‹Ðµ ÐºÐ°Ð½Ð´Ð¸Ð´Ð°Ñ‚Ñ‹):"
            docker exec -i izborator_postgres psql -U postgres -d izborator -c "
            SELECT 
                status,
                COUNT(*) as count
            FROM potential_shops
            GROUP BY status
            ORDER BY status;
            " || echo "âš ï¸  ÐÐµ ÑƒÐ´Ð°Ð»Ð¾ÑÑŒ Ð¿Ð¾Ð»ÑƒÑ‡Ð¸Ñ‚ÑŒ Ð´Ð°Ð½Ð½Ñ‹Ðµ"
            
            echo ""
            echo "âœ… ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð·Ð°Ð²ÐµÑ€ÑˆÐµÐ½Ð°!"
          EOF

      - name: Check .env Configuration
        run: |
          ssh root@${{ secrets.SERVER_HOST }} << 'EOF'
            set -e
            cd ~/Izborator
            
            echo ""
            echo "ðŸ” ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° ÐºÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸Ð¸ .env..."
            echo "=========================================="
            
            if [ -f .env ]; then
              echo "âœ… Ð¤Ð°Ð¹Ð» .env ÑÑƒÑ‰ÐµÑÑ‚Ð²ÑƒÐµÑ‚"
              
              # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ð½Ð°Ð»Ð¸Ñ‡Ð¸Ðµ Ð¾Ð±ÑÐ·Ð°Ñ‚ÐµÐ»ÑŒÐ½Ñ‹Ñ… Ð¿ÐµÑ€ÐµÐ¼ÐµÐ½Ð½Ñ‹Ñ…
              if grep -q "OPENAI_API_KEY=" .env && ! grep -q "OPENAI_API_KEY=$" .env && ! grep -q "OPENAI_API_KEY=your_" .env; then
                echo "âœ… OPENAI_API_KEY Ð½Ð°ÑÑ‚Ñ€Ð¾ÐµÐ½"
              else
                echo "âš ï¸  OPENAI_API_KEY Ð½Ðµ Ð½Ð°ÑÑ‚Ñ€Ð¾ÐµÐ½ Ð¸Ð»Ð¸ ÑÐ¾Ð´ÐµÑ€Ð¶Ð¸Ñ‚ placeholder"
              fi
              
              if grep -q "DB_PASSWORD=" .env && ! grep -q "DB_PASSWORD=$" .env && ! grep -q "DB_PASSWORD=your_" .env; then
                echo "âœ… DB_PASSWORD Ð½Ð°ÑÑ‚Ñ€Ð¾ÐµÐ½"
              else
                echo "âš ï¸  DB_PASSWORD Ð½Ðµ Ð½Ð°ÑÑ‚Ñ€Ð¾ÐµÐ½ Ð¸Ð»Ð¸ ÑÐ¾Ð´ÐµÑ€Ð¶Ð¸Ñ‚ placeholder"
              fi
              
              if grep -q "MEILISEARCH_API_KEY=" .env && ! grep -q "MEILISEARCH_API_KEY=$" .env && ! grep -q "MEILISEARCH_API_KEY=your_" .env; then
                echo "âœ… MEILISEARCH_API_KEY Ð½Ð°ÑÑ‚Ñ€Ð¾ÐµÐ½"
              else
                echo "âš ï¸  MEILISEARCH_API_KEY Ð½Ðµ Ð½Ð°ÑÑ‚Ñ€Ð¾ÐµÐ½ Ð¸Ð»Ð¸ ÑÐ¾Ð´ÐµÑ€Ð¶Ð¸Ñ‚ placeholder"
              fi
            else
              echo "âŒ Ð¤Ð°Ð¹Ð» .env Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½!"
              echo "âš ï¸  Ð¡Ð¾Ð·Ð´Ð°Ð¹Ñ‚Ðµ .env Ð¸Ð· .env.example Ð¸ Ð·Ð°Ð¿Ð¾Ð»Ð½Ð¸Ñ‚Ðµ Ð·Ð½Ð°Ñ‡ÐµÐ½Ð¸Ñ"
            fi
            
            echo ""
            echo "ðŸ³ ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° ÐºÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€Ð¾Ð²:"
            docker-compose ps backend worker || echo "âš ï¸  ÐÐµ ÑƒÐ´Ð°Ð»Ð¾ÑÑŒ Ð¿Ð¾Ð»ÑƒÑ‡Ð¸Ñ‚ÑŒ ÑÑ‚Ð°Ñ‚ÑƒÑ ÐºÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€Ð¾Ð²"
          EOF

      - name: Summary
        if: always()
        run: |
          echo "## ðŸ“Š Ð ÐµÐ·ÑƒÐ»ÑŒÑ‚Ð°Ñ‚Ñ‹ Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐºÐ¸ AutoConfig" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð²Ñ‹Ð¿Ð¾Ð»Ð½ÐµÐ½Ð°. Ð¡Ð¼Ð¾Ñ‚Ñ€Ð¸ Ð»Ð¾Ð³Ð¸ Ð²Ñ‹ÑˆÐµ Ð´Ð»Ñ Ð´ÐµÑ‚Ð°Ð»ÐµÐ¹." >> $GITHUB_STEP_SUMMARY

