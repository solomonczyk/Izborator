name: Check AutoConfig Results

on:
  workflow_dispatch: # –ü–æ–∑–≤–æ–ª—è–µ—Ç –∑–∞–ø—É—Å–∫–∞—Ç—å –≤—Ä—É—á–Ω—É—é
  schedule:
    # –ó–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –∫–∞–∂–¥—ã–π –¥–µ–Ω—å –≤ 6:00 UTC (–ø–æ—Å–ª–µ –≤–æ–∑–º–æ–∂–Ω–æ–≥–æ AutoConfig)
    - cron: '0 6 * * *'

jobs:
  check-results:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}
        
      - name: Add server to known hosts
        run: |
          ssh-keyscan -H ${{ secrets.SERVER_HOST }} >> ~/.ssh/known_hosts

      - name: Check AutoConfig Results
        run: |
          ssh root@${{ secrets.SERVER_HOST }} << 'EOF'
            set -e
            cd ~/Izborator
            
            echo "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ AutoConfig..."
            echo "=========================================="
            echo ""
            
            # –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–æ–∑–¥–∞–Ω–Ω—ã—Ö –º–∞–≥–∞–∑–∏–Ω–æ–≤
            echo "üìä –ú–∞–≥–∞–∑–∏–Ω—ã —Å is_auto_configured = true:"
            docker exec -i izborator_postgres psql -U postgres -d izborator -c "
            SELECT 
                id,
                name, 
                base_url, 
                is_active, 
                is_auto_configured,
                created_at 
            FROM shops 
            WHERE is_auto_configured = true 
            ORDER BY created_at DESC;
            " || echo "‚ö†Ô∏è  –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –¥–∞–Ω–Ω—ã–µ"
            
            echo ""
            echo "üìà –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –º–∞–≥–∞–∑–∏–Ω–∞–º:"
            docker exec -i izborator_postgres psql -U postgres -d izborator -c "
            SELECT 
                COUNT(*) FILTER (WHERE is_auto_configured = true) as auto_configured_count,
                COUNT(*) FILTER (WHERE is_auto_configured = false) as manual_count,
                COUNT(*) as total_shops
            FROM shops;
            " || echo "‚ö†Ô∏è  –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É"
            
            echo ""
            echo "üîß –ü—Ä–æ–≤–µ—Ä–∫–∞ shop_config_attempts:"
            docker exec -i izborator_postgres psql -U postgres -d izborator -c "
            SELECT 
                status,
                COUNT(*) as count
            FROM shop_config_attempts
            GROUP BY status
            ORDER BY status;
            " || echo "‚ö†Ô∏è  –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –¥–∞–Ω–Ω—ã–µ"
            
            echo ""
            echo "üìã –ü—Ä–æ–≤–µ—Ä–∫–∞ potential_shops (–∫–ª–∞—Å—Å–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –∫–∞–Ω–¥–∏–¥–∞—Ç—ã):"
            docker exec -i izborator_postgres psql -U postgres -d izborator -c "
            SELECT 
                status,
                COUNT(*) as count
            FROM potential_shops
            GROUP BY status
            ORDER BY status;
            " 2>/dev/null || echo "‚ö†Ô∏è  –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –¥–∞–Ω–Ω—ã–µ"
            
            echo ""
            echo "üîç –î–µ—Ç–∞–ª–∏ –ø–æ –∫–ª–∞—Å—Å–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω—ã–º –∫–∞–Ω–¥–∏–¥–∞—Ç–∞–º:"
            CLASSIFIED_COUNT=$(docker exec -i izborator_postgres psql -U postgres -d izborator -t -A -c "
            SELECT COUNT(*) 
            FROM potential_shops 
            WHERE status = 'classified';
            " 2>/dev/null | tr -d ' \n')
            
            if [ -n "$CLASSIFIED_COUNT" ] && [ "$CLASSIFIED_COUNT" -gt 0 ]; then
              echo "‚úÖ –ù–∞–π–¥–µ–Ω–æ $CLASSIFIED_COUNT –∫–ª–∞—Å—Å–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –∫–∞–Ω–¥–∏–¥–∞—Ç–æ–≤ –¥–ª—è AutoConfig"
            else
              echo "‚ö†Ô∏è  –ö–ª–∞—Å—Å–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –∫–∞–Ω–¥–∏–¥–∞—Ç–æ–≤ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ (0)"
              echo "üí° –ù—É–∂–Ω–æ –∑–∞–ø—É—Å—Ç–∏—Ç—å Classifier: docker-compose run --rm backend ./classifier -classify-all"
            fi
            
            echo ""
            echo "‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞!"
          EOF

      - name: Check .env Configuration
        run: |
          ssh root@${{ secrets.SERVER_HOST }} << 'EOF'
            set -e
            cd ~/Izborator
            
            echo ""
            echo "üîê –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ .env..."
            echo "=========================================="
            
            if [ -f .env ]; then
              echo "‚úÖ –§–∞–π–ª .env —Å—É—â–µ—Å—Ç–≤—É–µ—Ç"
              
              # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã—Ö –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö
              if grep -q "OPENAI_API_KEY=" .env && ! grep -q "OPENAI_API_KEY=$" .env && ! grep -q "OPENAI_API_KEY=your_" .env; then
                echo "‚úÖ OPENAI_API_KEY –Ω–∞—Å—Ç—Ä–æ–µ–Ω"
              else
                echo "‚ö†Ô∏è  OPENAI_API_KEY –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω –∏–ª–∏ —Å–æ–¥–µ—Ä–∂–∏—Ç placeholder"
              fi
              
              if grep -q "DB_PASSWORD=" .env && ! grep -q "DB_PASSWORD=$" .env && ! grep -q "DB_PASSWORD=your_" .env; then
                echo "‚úÖ DB_PASSWORD –Ω–∞—Å—Ç—Ä–æ–µ–Ω"
              else
                echo "‚ö†Ô∏è  DB_PASSWORD –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω –∏–ª–∏ —Å–æ–¥–µ—Ä–∂–∏—Ç placeholder"
              fi
              
              if grep -q "MEILISEARCH_API_KEY=" .env && ! grep -q "MEILISEARCH_API_KEY=$" .env && ! grep -q "MEILISEARCH_API_KEY=your_" .env; then
                echo "‚úÖ MEILISEARCH_API_KEY –Ω–∞—Å—Ç—Ä–æ–µ–Ω"
              else
                echo "‚ö†Ô∏è  MEILISEARCH_API_KEY –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω –∏–ª–∏ —Å–æ–¥–µ—Ä–∂–∏—Ç placeholder"
              fi
            else
              echo "‚ùå –§–∞–π–ª .env –Ω–µ –Ω–∞–π–¥–µ–Ω!"
              echo "‚ö†Ô∏è  –°–æ–∑–¥–∞–π—Ç–µ .env –∏–∑ .env.example –∏ –∑–∞–ø–æ–ª–Ω–∏—Ç–µ –∑–Ω–∞—á–µ–Ω–∏—è"
            fi
            
            echo ""
            echo "üê≥ –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤:"
            docker-compose ps backend worker || echo "‚ö†Ô∏è  –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å —Å—Ç–∞—Ç—É—Å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤"
          EOF

      - name: Summary
        if: always()
        run: |
          echo "## üìä –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø—Ä–æ–≤–µ—Ä–∫–∏ AutoConfig" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "–ü—Ä–æ–≤–µ—Ä–∫–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∞. –°–º–æ—Ç—Ä–∏ –ª–æ–≥–∏ –≤—ã—à–µ –¥–ª—è –¥–µ—Ç–∞–ª–µ–π." >> $GITHUB_STEP_SUMMARY

