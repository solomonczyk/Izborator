name: Test Drive - Project Horizon

on:
  workflow_dispatch: # –ü–æ–∑–≤–æ–ª—è–µ—Ç –∑–∞–ø—É—Å–∫–∞—Ç—å –≤—Ä—É—á–Ω—É—é
  push:
    branches:
      - main
    paths:
      - 'test-autoconfig-chain.sh'
      - '.github/workflows/test-drive.yml'

jobs:
  test-drive:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}
        
      - name: Add server to known hosts
        run: |
          ssh-keyscan -H ${{ secrets.SERVER_HOST }} >> ~/.ssh/known_hosts

      - name: Run Test Drive
        run: |
          ssh root@${{ secrets.SERVER_HOST }} << 'EOF'
            set -e
            cd ~/Izborator
            
            echo "üöÄ Project Horizon - –§–∏–Ω–∞–ª—å–Ω—ã–π –¢–µ—Å—Ç-–î—Ä–∞–π–≤"
            echo "=========================================="
            echo ""
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–∞–Ω–¥–∏–¥–∞—Ç–æ–≤
            echo "üìä –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–µ–∫—É—â–µ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è..."
            CANDIDATES_NEW=$(docker-compose exec -T postgres psql -U postgres -d izborator -t -c "SELECT COUNT(*) FROM potential_shops WHERE status = 'new';" | tr -d ' ')
            CANDIDATES_CLASSIFIED=$(docker-compose exec -T postgres psql -U postgres -d izborator -t -c "SELECT COUNT(*) FROM potential_shops WHERE status = 'classified';" | tr -d ' ')
            
            echo "–ö–∞–Ω–¥–∏–¥–∞—Ç–æ–≤ —Å–æ —Å—Ç–∞—Ç—É—Å–æ–º 'new': $CANDIDATES_NEW"
            echo "–ö–∞–Ω–¥–∏–¥–∞—Ç–æ–≤ —Å–æ —Å—Ç–∞—Ç—É—Å–æ–º 'classified': $CANDIDATES_CLASSIFIED"
            echo ""
            
            # –®–∞–≥ 1: Discovery (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ)
            if [ "$CANDIDATES_NEW" -eq "0" ] && [ "$CANDIDATES_CLASSIFIED" -eq "0" ]; then
              echo "üîç –®–∞–≥ 1: –ó–∞–ø—É—Å–∫ Discovery (–ø–æ–∏—Å–∫ –∫–∞–Ω–¥–∏–¥–∞—Ç–æ–≤)..."
              docker-compose run --rm backend ./discovery || echo "‚ö†Ô∏è  Discovery –∑–∞–≤–µ—Ä—à–∏–ª—Å—è —Å –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è–º–∏"
              echo "‚úÖ Discovery –∑–∞–≤–µ—Ä—à–µ–Ω"
              echo ""
            else
              echo "‚úÖ –ö–∞–Ω–¥–∏–¥–∞—Ç—ã —É–∂–µ –µ—Å—Ç—å, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º Discovery"
              echo ""
            fi
            
            # –®–∞–≥ 2: Classifier
            echo "üîç –®–∞–≥ 2: –ó–∞–ø—É—Å–∫ Classifier (–∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏—è)..."
            docker-compose run --rm backend ./classifier -classify-all -limit 10 || echo "‚ö†Ô∏è  Classifier –∑–∞–≤–µ—Ä—à–∏–ª—Å—è —Å –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è–º–∏"
            
            NEW_CLASSIFIED=$(docker-compose exec -T postgres psql -U postgres -d izborator -t -c "SELECT COUNT(*) FROM potential_shops WHERE status = 'classified';" | tr -d ' ')
            echo "‚úÖ –ö–ª–∞—Å—Å–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–æ –º–∞–≥–∞–∑–∏–Ω–æ–≤: $NEW_CLASSIFIED"
            echo ""
            
            if [ "$NEW_CLASSIFIED" -eq "0" ]; then
              echo "‚ùå –ù–µ—Ç –∫–ª–∞—Å—Å–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –º–∞–≥–∞–∑–∏–Ω–æ–≤ –¥–ª—è AutoConfig!"
              exit 1
            fi
            
            # –®–∞–≥ 3: AutoConfig
            echo "ü§ñ –®–∞–≥ 3: –ó–∞–ø—É—Å–∫ AutoConfig (AI –≥–µ–Ω–µ—Ä–∞—Ü–∏—è —Å–µ–ª–µ–∫—Ç–æ—Ä–æ–≤)..."
            echo "–û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º 1 –∫–∞–Ω–¥–∏–¥–∞—Ç–∞ –¥–ª—è —Ç–µ—Å—Ç–∞..."
            docker-compose run --rm backend ./autoconfig -limit 1 || echo "‚ö†Ô∏è  AutoConfig –∑–∞–≤–µ—Ä—à–∏–ª—Å—è —Å –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è–º–∏"
            echo ""
            
            # –®–∞–≥ 4: –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞
            echo "üìä –®–∞–≥ 4: –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞..."
            echo ""
            echo "–ü–æ—Å–ª–µ–¥–Ω–∏–π —Å–æ–∑–¥–∞–Ω–Ω—ã–π –º–∞–≥–∞–∑–∏–Ω:"
            docker-compose exec -T postgres psql -U postgres -d izborator -c "
              SELECT 
                  name, 
                  base_url, 
                  is_auto_configured,
                  ai_config_model,
                  selectors->>'name' as name_selector,
                  selectors->>'price' as price_selector,
                  created_at
              FROM shops 
              WHERE is_auto_configured = true 
              ORDER BY created_at DESC 
              LIMIT 1;
            " || echo "‚ö†Ô∏è  –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç"
            
            echo ""
            echo "–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ —Å—Ç–∞—Ç—É—Å–∞–º:"
            docker-compose exec -T postgres psql -U postgres -d izborator -c "
              SELECT 
                  status,
                  COUNT(*) as count
              FROM potential_shops
              GROUP BY status
              ORDER BY status;
            " || echo "‚ö†Ô∏è  –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É"
            
            echo ""
            echo "–ü–æ–ø—ã—Ç–∫–∏ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏:"
            docker-compose exec -T postgres psql -U postgres -d izborator -c "
              SELECT 
                  status,
                  COUNT(*) as count,
                  MAX(created_at) as last_attempt
              FROM shop_config_attempts
              GROUP BY status
              ORDER BY status;
            " || echo "‚ö†Ô∏è  –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –ø–æ–ø—ã—Ç–æ–∫"
            
            echo ""
            echo "‚úÖ –¢–µ—Å—Ç-–¥—Ä–∞–π–≤ –∑–∞–≤–µ—Ä—à–µ–Ω!"
          EOF

      - name: Notify completion
        if: always()
        run: |
          if [ "${{ job.status }}" == "success" ]; then
            echo "‚úÖ –¢–µ—Å—Ç-–¥—Ä–∞–π–≤ –∑–∞–≤–µ—Ä—à–µ–Ω —É—Å–ø–µ—à–Ω–æ!"
          else
            echo "‚ùå –¢–µ—Å—Ç-–¥—Ä–∞–π–≤ –∑–∞–≤–µ—Ä—à–∏–ª—Å—è —Å –æ—à–∏–±–∫–∞–º–∏!"
          fi

