name: Run AutoConfig

on:
  workflow_dispatch: # –ü–æ–∑–≤–æ–ª—è–µ—Ç –∑–∞–ø—É—Å–∫–∞—Ç—å –≤—Ä—É—á–Ω—É—é
  schedule:
    # –ó–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –∫–∞–∂–¥—ã–π –¥–µ–Ω—å –≤ 5:00 UTC (–ø–µ—Ä–µ–¥ –ø—Ä–æ–≤–µ—Ä–∫–æ–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤)
    - cron: '0 5 * * *'

jobs:
  run-autoconfig:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}
        
      - name: Add server to known hosts
        run: |
          ssh-keyscan -H ${{ secrets.SERVER_HOST }} >> ~/.ssh/known_hosts

      - name: Check classified candidates
        id: check-candidates
        run: |
          # –ü–æ–ª—É—á–∞–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ —á–µ—Ä–µ–∑ SSH, —Ñ–∏–ª—å—Ç—Ä—É—è —Ç–æ–ª—å–∫–æ —á–∏—Å–ª–æ–≤—ã–µ —Å—Ç—Ä–æ–∫–∏
          CLASSIFIED_COUNT=$(ssh -q -o LogLevel=ERROR -o UserKnownHostsFile=/dev/null -o StrictHostKeyChecking=no root@${{ secrets.SERVER_HOST }} << 'EOF' 2>/dev/null | grep -E '^[0-9]+$' | head -1
            docker exec -i izborator_postgres psql -U postgres -d izborator -t -A -c "
            SELECT COUNT(*) 
            FROM potential_shops 
            WHERE status = 'classified';
            " 2>/dev/null
          EOF
          )
          # –í–∞–ª–∏–¥–∞—Ü–∏—è: –ø—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –∑–Ω–∞—á–µ–Ω–∏–µ - —ç—Ç–æ —á–∏—Å–ª–æ
          if [ -z "$CLASSIFIED_COUNT" ] || ! [[ "$CLASSIFIED_COUNT" =~ ^[0-9]+$ ]]; then
            echo "‚ö†Ô∏è  Invalid or empty count value, defaulting to 0"
            CLASSIFIED_COUNT=0
          fi
          echo "count=$CLASSIFIED_COUNT" >> $GITHUB_OUTPUT
          echo "üìä Found $CLASSIFIED_COUNT classified candidates"

      - name: Run AutoConfig
        if: steps.check-candidates.outputs.count > 0
        run: |
          ssh root@${{ secrets.SERVER_HOST }} << 'EOF'
            set -e
            cd ~/Izborator
            
            echo "ü§ñ Running AutoConfig..."
            echo "=========================================="
            
            # –ó–∞–≥—Ä—É–∂–∞–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –∏–∑ .env
            export $(cat .env | grep -v '^#' | xargs)
            
            # –ó–∞–ø—É—Å–∫–∞–µ–º AutoConfig (–æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –¥–æ 10 –º–∞–≥–∞–∑–∏–Ω–æ–≤)
            docker-compose run --rm \
              -e OPENAI_API_KEY="${OPENAI_API_KEY}" \
              -e OPENAI_MODEL="${OPENAI_MODEL:-gpt-4o-mini}" \
              backend ./autoconfig -limit 10 2>&1 | tee /tmp/autoconfig.log || true
            
            echo ""
            echo "‚úÖ AutoConfig completed!"
            echo ""
            
            # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–µ —Å—Ç—Ä–æ–∫–∏ –ª–æ–≥–æ–≤
            echo "üìã Last 20 lines of AutoConfig logs:"
            tail -20 /tmp/autoconfig.log || echo "‚ö†Ô∏è  Could not read logs"
          EOF

      - name: Show results
        if: steps.check-candidates.outputs.count > 0
        run: |
          ssh root@${{ secrets.SERVER_HOST }} << 'EOF'
            set -e
            cd ~/Izborator
            
            echo ""
            echo "üìä AutoConfig Results:"
            echo "=========================================="
            
            # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–∑–¥–∞–Ω–Ω—ã–µ –º–∞–≥–∞–∑–∏–Ω—ã
            echo "üõçÔ∏è  Auto-configured shops:"
            docker exec -i izborator_postgres psql -U postgres -d izborator -c "
            SELECT 
                id,
                name, 
                base_url, 
                is_active, 
                is_auto_configured,
                created_at 
            FROM shops 
            WHERE is_auto_configured = true 
            ORDER BY created_at DESC
            LIMIT 10;
            " || echo "‚ö†Ô∏è  Could not fetch shops"
            
            echo ""
            echo "üìà Statistics:"
            docker exec -i izborator_postgres psql -U postgres -d izborator -c "
            SELECT 
                COUNT(*) FILTER (WHERE is_auto_configured = true) as auto_configured_count,
                COUNT(*) FILTER (WHERE is_auto_configured = false) as manual_count,
                COUNT(*) as total_shops
            FROM shops;
            " || echo "‚ö†Ô∏è  Could not fetch statistics"
            
            echo ""
            echo "üîß Config attempts status:"
            docker exec -i izborator_postgres psql -U postgres -d izborator -c "
            SELECT 
                status,
                COUNT(*) as count
            FROM shop_config_attempts
            GROUP BY status
            ORDER BY status;
            " || echo "‚ö†Ô∏è  Could not fetch attempts"
          EOF

      - name: No candidates message
        if: steps.check-candidates.outputs.count == 0
        run: |
          echo "‚ö†Ô∏è  No classified candidates found. Run Classifier first:"
          echo "   docker-compose run --rm backend ./classifier -classify-all"

      - name: Summary
        if: always()
        run: |
          echo "## ü§ñ AutoConfig Execution" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "${{ steps.check-candidates.outputs.count }}" -gt "0" ]; then
            echo "‚úÖ AutoConfig executed for ${{ steps.check-candidates.outputs.count }} candidates" >> $GITHUB_STEP_SUMMARY
          else
            echo "‚ö†Ô∏è  No classified candidates found. Run Classifier first." >> $GITHUB_STEP_SUMMARY
          fi

