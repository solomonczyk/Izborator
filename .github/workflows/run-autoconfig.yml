name: Run AutoConfig

on:
  workflow_dispatch: # ÐŸÐ¾Ð·Ð²Ð¾Ð»ÑÐµÑ‚ Ð·Ð°Ð¿ÑƒÑÐºÐ°Ñ‚ÑŒ Ð²Ñ€ÑƒÑ‡Ð½ÑƒÑŽ
  schedule:
    # Ð—Ð°Ð¿ÑƒÑÐºÐ°ÐµÑ‚ÑÑ ÐºÐ°Ð¶Ð´Ñ‹Ð¹ Ð´ÐµÐ½ÑŒ Ð² 5:00 UTC (Ð¿ÐµÑ€ÐµÐ´ Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐºÐ¾Ð¹ Ñ€ÐµÐ·ÑƒÐ»ÑŒÑ‚Ð°Ñ‚Ð¾Ð²)
    - cron: '0 5 * * *'

jobs:
  run-autoconfig:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}
        
      - name: Add server to known hosts
        run: |
          ssh-keyscan -H ${{ secrets.SERVER_HOST }} >> ~/.ssh/known_hosts

      - name: Check classified candidates
        id: check-candidates
        run: |
          CLASSIFIED_COUNT=$(ssh root@${{ secrets.SERVER_HOST }} << 'EOF'
            docker exec -i izborator_postgres psql -U postgres -d izborator -t -c "
            SELECT COUNT(*) 
            FROM potential_shops 
            WHERE status = 'classified';
            " | tr -d ' \n'
          EOF
          )
          echo "count=$CLASSIFIED_COUNT" >> $GITHUB_OUTPUT
          echo "ðŸ“Š Found $CLASSIFIED_COUNT classified candidates"

      - name: Run AutoConfig
        if: steps.check-candidates.outputs.count > 0
        run: |
          ssh root@${{ secrets.SERVER_HOST }} << 'EOF'
            set -e
            cd ~/Izborator
            
            echo "ðŸ¤– Running AutoConfig..."
            echo "=========================================="
            
            # Ð—Ð°Ð³Ñ€ÑƒÐ¶Ð°ÐµÐ¼ Ð¿ÐµÑ€ÐµÐ¼ÐµÐ½Ð½Ñ‹Ðµ Ð¸Ð· .env
            export $(cat .env | grep -v '^#' | xargs)
            
            # Ð—Ð°Ð¿ÑƒÑÐºÐ°ÐµÐ¼ AutoConfig (Ð¾Ð±Ñ€Ð°Ð±Ð°Ñ‚Ñ‹Ð²Ð°ÐµÐ¼ Ð´Ð¾ 10 Ð¼Ð°Ð³Ð°Ð·Ð¸Ð½Ð¾Ð²)
            docker-compose run --rm \
              -e OPENAI_API_KEY="${OPENAI_API_KEY}" \
              -e OPENAI_MODEL="${OPENAI_MODEL:-gpt-4o-mini}" \
              backend ./autoconfig -limit 10 2>&1 | tee /tmp/autoconfig.log || true
            
            echo ""
            echo "âœ… AutoConfig completed!"
            echo ""
            
            # ÐŸÐ¾ÐºÐ°Ð·Ñ‹Ð²Ð°ÐµÐ¼ Ð¿Ð¾ÑÐ»ÐµÐ´Ð½Ð¸Ðµ ÑÑ‚Ñ€Ð¾ÐºÐ¸ Ð»Ð¾Ð³Ð¾Ð²
            echo "ðŸ“‹ Last 20 lines of AutoConfig logs:"
            tail -20 /tmp/autoconfig.log || echo "âš ï¸  Could not read logs"
          EOF

      - name: Show results
        if: steps.check-candidates.outputs.count > 0
        run: |
          ssh root@${{ secrets.SERVER_HOST }} << 'EOF'
            set -e
            cd ~/Izborator
            
            echo ""
            echo "ðŸ“Š AutoConfig Results:"
            echo "=========================================="
            
            # ÐŸÐ¾ÐºÐ°Ð·Ñ‹Ð²Ð°ÐµÐ¼ ÑÐ¾Ð·Ð´Ð°Ð½Ð½Ñ‹Ðµ Ð¼Ð°Ð³Ð°Ð·Ð¸Ð½Ñ‹
            echo "ðŸ›ï¸  Auto-configured shops:"
            docker exec -i izborator_postgres psql -U postgres -d izborator -c "
            SELECT 
                id,
                name, 
                base_url, 
                is_active, 
                is_auto_configured,
                created_at 
            FROM shops 
            WHERE is_auto_configured = true 
            ORDER BY created_at DESC
            LIMIT 10;
            " || echo "âš ï¸  Could not fetch shops"
            
            echo ""
            echo "ðŸ“ˆ Statistics:"
            docker exec -i izborator_postgres psql -U postgres -d izborator -c "
            SELECT 
                COUNT(*) FILTER (WHERE is_auto_configured = true) as auto_configured_count,
                COUNT(*) FILTER (WHERE is_auto_configured = false) as manual_count,
                COUNT(*) as total_shops
            FROM shops;
            " || echo "âš ï¸  Could not fetch statistics"
            
            echo ""
            echo "ðŸ”§ Config attempts status:"
            docker exec -i izborator_postgres psql -U postgres -d izborator -c "
            SELECT 
                status,
                COUNT(*) as count
            FROM shop_config_attempts
            GROUP BY status
            ORDER BY status;
            " || echo "âš ï¸  Could not fetch attempts"
          EOF

      - name: No candidates message
        if: steps.check-candidates.outputs.count == 0
        run: |
          echo "âš ï¸  No classified candidates found. Run Classifier first:"
          echo "   docker-compose run --rm backend ./classifier -classify-all"

      - name: Summary
        if: always()
        run: |
          echo "## ðŸ¤– AutoConfig Execution" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "${{ steps.check-candidates.outputs.count }}" -gt "0" ]; then
            echo "âœ… AutoConfig executed for ${{ steps.check-candidates.outputs.count }} candidates" >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸  No classified candidates found. Run Classifier first." >> $GITHUB_STEP_SUMMARY
          fi

