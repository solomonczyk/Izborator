name: Load Test Products

on:
  workflow_dispatch:  # –†—É—á–Ω–æ–π –∑–∞–ø—É—Å–∫

jobs:
  load-products:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}
        
      - name: Add server to known hosts
        run: |
          ssh-keyscan -H ${{ secrets.SERVER_HOST }} >> ~/.ssh/known_hosts

      - name: Load test products and reindex
        run: |
          ssh root@${{ secrets.SERVER_HOST }} << 'EOF'
            set -e
            cd /root/Izborator
            
            echo "üì¶ Loading test products to production database..."
            
            # 1. –ó–∞–≥—Ä—É–∂–∞–µ–º —Ç–µ—Å—Ç–æ–≤—ã–µ —Ç–æ–≤–∞—Ä—ã –≤ PostgreSQL
            echo "1Ô∏è‚É£  Loading test data into PostgreSQL..."
            docker-compose exec -T postgres psql -U postgres -d izborator << 'SQLEOF'
            
            -- –û—á–∏—â–∞–µ–º —Å—Ç–∞—Ä—ã–µ —Ç–µ—Å—Ç–æ–≤—ã–µ —Ç–æ–≤–∞—Ä—ã (–µ—Å–ª–∏ –µ—Å—Ç—å)
            DELETE FROM products WHERE id LIKE 'aaaaaaaa%' OR id LIKE 'bbbbbbbb%' OR id LIKE 'cccccccc%' OR id LIKE 'dddddddd%';
            
            -- –ó–∞–≥—Ä—É–∂–∞–µ–º –Ω–æ–≤—ã–µ —Ç–µ—Å—Ç–æ–≤—ã–µ —Ç–æ–≤–∞—Ä—ã
            INSERT INTO products (id, name, description, brand, category, category_id, image_url, specs, created_at, updated_at)
            VALUES
              ('aaaaaaaa-aaaa-aaaa-aaaa-aaaaaaaaaaaa', 'Nike Air Max 90', '–ö–ª–∞—Å—Å–∏—á–µ—Å–∫–∏–µ –∫—Ä–æ—Å—Å–æ–≤–∫–∏ Nike Air Max 90 —Å –∞–º–æ—Ä—Ç–∏–∑–∞—Ü–∏–µ–π Air', 'Nike', 'Sport i rekreacija', '55555555-5555-5555-5555-555555555555', 'https://placehold.co/400x400/000000/FFFFFF?text=Nike+Air+Max+90', '{"size": "42", "color": "Black/White"}'::jsonb, NOW(), NOW()),
              ('bbbbbbbb-bbbb-bbbb-bbbb-bbbbbbbbbbbb', 'Samsung Galaxy S24', '–§–ª–∞–≥–º–∞–Ω—Å–∫–∏–π —Å–º–∞—Ä—Ç—Ñ–æ–Ω Samsung —Å –∫–∞–º–µ—Ä–æ–π 200MP', 'Samsung', 'Mobilni telefoni', '11111111-1111-1111-1111-111111111201', 'https://placehold.co/400x400/000000/FFFFFF.png?text=Samsung+Galaxy+S24', '{"storage": "256GB", "ram": "8GB"}'::jsonb, NOW(), NOW()),
              ('cccccccc-cccc-cccc-cccc-cccccccccccc', 'Lenovo IdeaPad 3', '–ù–æ—É—Ç–±—É–∫ Lenovo IdeaPad 3 —Å –ø—Ä–æ—Ü–µ—Å—Å–æ—Ä–æ–º AMD Ryzen 5', 'Lenovo', 'Laptopovi', '11111111-1111-1111-1111-111111111202', 'https://placehold.co/400x400/000000/FFFFFF.png?text=Lenovo+IdeaPad+3', '{"cpu": "AMD Ryzen 5", "ram": "8GB"}'::jsonb, NOW(), NOW()),
              ('dddddddd-dddd-dddd-dddd-dddddddddddd', 'Samsung 55\" QLED TV', '–¢–µ–ª–µ–≤–∏–∑–æ—Ä Samsung 55 –¥—é–π–º–æ–≤ —Å —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–µ–π QLED', 'Samsung', 'Televizori', '11111111-1111-1111-1111-111111111203', 'https://placehold.co/400x400/000000/FFFFFF.png?text=Samsung+55+QLED', '{"size": "55 inch", "resolution": "4K UHD"}'::jsonb, NOW(), NOW())
            ON CONFLICT (id) DO UPDATE SET updated_at = NOW();
            
            SQLEOF
            
            echo "‚úÖ Test products loaded!"
            
            # 2. –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ —Ç–æ–≤–∞—Ä—ã –≤ –ë–î
            echo ""
            echo "2Ô∏è‚É£  Verifying products in PostgreSQL..."
            docker-compose exec -T postgres psql -U postgres -d izborator -c "SELECT COUNT(*) as product_count FROM products WHERE id LIKE '%aaaa%' OR id LIKE '%bbbb%' OR id LIKE '%cccc%' OR id LIKE '%dddd%';"
            
            # 3. –ü–µ—Ä–µ–∏–Ω–¥–µ–∫—Å–∏—Ä—É–µ–º Meilisearch
            echo ""
            echo "3Ô∏è‚É£  Re-indexing Meilisearch..."
            cd /root/Izborator/backend
            go run cmd/indexer/main.go -reindex
            
            if [ $? -eq 0 ]; then
              echo "‚úÖ Re-indexing completed!"
            else
              echo "‚ö†Ô∏è Re-indexing failed"
              exit 1
            fi
            
            # 4. –ü—Ä–æ–≤–µ—Ä—è–µ–º Meilisearch –∏–Ω–¥–µ–∫—Å
            echo ""
            echo "4Ô∏è‚É£  Checking Meilisearch index..."
            curl -s http://meilisearch:7700/indexes/products/stats | jq . || echo "Could not reach Meilisearch"
            
            # 5. –¢–µ—Å—Ç–∏—Ä—É–µ–º –ø–æ–∏—Å–∫
            echo ""
            echo "5Ô∏è‚É£  Testing search..."
            RESULT=$(curl -s "http://backend:8080/api/v1/products/search?q=Samsung" | jq '.[] | length' 2>/dev/null || echo "0")
            echo "Search result count: $RESULT"
            
            if [ "$RESULT" -gt "0" ]; then
              echo "‚úÖ Search is working! Found Samsung products."
            else
              echo "‚ö†Ô∏è Search returned no results"
            fi
            
            echo ""
            echo "üéâ Test data loading completed!"
          
          EOF

      - name: Verify on production
        run: |
          ssh root@${{ secrets.SERVER_HOST }} << 'EOF'
            echo ""
            echo "üîç Final verification:"
            echo ""
            echo "Products in database:"
            docker-compose exec -T postgres psql -U postgres -d izborator -c "SELECT id, name FROM products WHERE id LIKE '%aaaa%' LIMIT 5;"
            echo ""
            echo "Try searching at: https://152.53.227.37/en/catalog?q=Samsung"
          EOF
