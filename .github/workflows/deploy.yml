name: Deploy to Production

on:
  push:
    branches:
      - main
  workflow_dispatch: # –ü–æ–∑–≤–æ–ª—è–µ—Ç –∑–∞–ø—É—Å–∫–∞—Ç—å –≤—Ä—É—á–Ω—É—é

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}
        
      - name: Verify SSH key is set
        if: env.SSH_PRIVATE_KEY == ''
        run: |
          echo "‚ùå Error: SSH_PRIVATE_KEY secret is not configured!"
          echo "Please add SSH_PRIVATE_KEY secret in GitHub Settings ‚Üí Secrets and variables ‚Üí Actions"
          exit 1
        env:
          SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: Add server to known hosts
        run: |
          ssh-keyscan -H ${{ secrets.SERVER_HOST }} >> ~/.ssh/known_hosts

      - name: Deploy to server
        run: |
          ssh root@${{ secrets.SERVER_HOST }} << 'EOF'
            set -e
            cd ~/Izborator
            
            # –û–±–Ω–æ–≤–ª—è–µ–º –∫–æ–¥ (—Å–±—Ä–∞—Å—ã–≤–∞–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è)
            echo "üì• Pulling latest changes..."
            git fetch origin
            git reset --hard origin/main
            git clean -fd
            
            # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º SSL —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—ã, –µ—Å–ª–∏ –∏—Ö –Ω–µ—Ç
            if [ ! -f nginx/ssl/cert.pem ]; then
              echo "üîê Generating SSL certificates..."
              mkdir -p nginx/ssl
              cd nginx
              chmod +x generate-ssl.sh
              ./generate-ssl.sh
              cd ..
            fi
            
            # –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å—Ç–∞—Ä—ã–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã (–µ—Å–ª–∏ –µ—Å—Ç—å)
            echo "üõë Stopping old containers..."
            docker-compose down || true
            
            # –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã, –∫–æ—Ç–æ—Ä—ã–µ –º–æ–≥—É—Ç –∑–∞–Ω–∏–º–∞—Ç—å –ø–æ—Ä—Ç—ã 80/443
            echo "üîç Checking for containers using ports 80/443..."
            # –ù–∞—Ö–æ–¥–∏–º –≤—Å–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã (–≤–∫–ª—é—á–∞—è –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ) –∏ –ø—Ä–æ–≤–µ—Ä—è–µ–º –∏—Ö –ø–æ—Ä—Ç—ã
            for container in $(docker ps -a --format "{{.ID}}"); do
              ports=$(docker port "$container" 2>/dev/null || echo "")
              if echo "$ports" | grep -qE ":(80|443)->"; then
                echo "Stopping container $container using ports 80/443..."
                docker stop "$container" 2>/dev/null || true
                docker rm "$container" 2>/dev/null || true
              fi
            done
            
            # –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ: –ø—Ä–æ–≤–µ—Ä—è–µ–º —á–µ—Ä–µ–∑ ss/netstat, —á—Ç–æ –∑–∞–Ω–∏–º–∞–µ—Ç –ø–æ—Ä—Ç—ã
            echo "üîç Checking system ports..."
            if command -v ss >/dev/null 2>&1; then
              for port in 80 443; do
                pid=$(ss -tlnp | grep ":$port " | awk '{print $6}' | cut -d',' -f2 | cut -d'=' -f2 | head -1)
                if [ ! -z "$pid" ] && [ "$pid" != "-" ]; then
                  echo "Port $port is used by process $pid, checking if it's a container..."
                  # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ —è–≤–ª—è–µ—Ç—Å—è –ª–∏ —ç—Ç–æ Docker –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–º
                  container=$(docker ps --format "{{.ID}}\t{{.Pid}}" | grep "$pid" | awk '{print $1}' | head -1)
                  if [ ! -z "$container" ]; then
                    echo "Stopping container $container..."
                    docker stop "$container" 2>/dev/null || true
                    docker rm "$container" 2>/dev/null || true
                  fi
                fi
              done
            fi
            
            # –ü–µ—Ä–µ—Å–æ–±–∏—Ä–∞–µ–º –∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã
            echo "üî® Building and restarting containers..."
            docker-compose build
            docker-compose up -d
            
            # –ñ–¥–µ–º –∑–∞–ø—É—Å–∫–∞ —Å–µ—Ä–≤–∏—Å–æ–≤
            echo "‚è≥ Waiting for services to start..."
            sleep 10
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å
            echo "‚úÖ Checking services status..."
            docker-compose ps
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º health
            echo "üè• Health check..."
            curl -f http://localhost/api/health || exit 1
            
            echo "üéâ Deployment completed successfully!"
          EOF

      - name: Notify deployment status
        if: always()
        run: |
          if [ "${{ job.status }}" == "success" ]; then
            echo "‚úÖ Deployment successful!"
          else
            echo "‚ùå Deployment failed!"
          fi

