name: Deploy to Production

on:
  push:
    branches:
      - main
  workflow_dispatch: # –ü–æ–∑–≤–æ–ª—è–µ—Ç –∑–∞–ø—É—Å–∫–∞—Ç—å –≤—Ä—É—á–Ω—É—é

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}
        
      - name: Verify SSH key is set
        if: env.SSH_PRIVATE_KEY == ''
        run: |
          echo "‚ùå Error: SSH_PRIVATE_KEY secret is not configured!"
          echo "Please add SSH_PRIVATE_KEY secret in GitHub Settings ‚Üí Secrets and variables ‚Üí Actions"
          exit 1
        env:
          SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: Add server to known hosts
        run: |
          ssh-keyscan -H ${{ secrets.SERVER_HOST }} >> ~/.ssh/known_hosts

      - name: Deploy to server
        run: |
          ssh root@${{ secrets.SERVER_HOST }} << 'EOF'
            set -e
            cd ~/Izborator
            
            # –û–±–Ω–æ–≤–ª—è–µ–º –∫–æ–¥ (—Å–±—Ä–∞—Å—ã–≤–∞–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è)
            echo "üì• Pulling latest changes..."
            git fetch origin --prune
            git reset --hard origin/main || {
              echo "‚ö†Ô∏è  Git reset failed, trying to fix refs..."
              git remote prune origin
              git fetch origin --prune
              git reset --hard origin/main
            }
            git clean -fd
            
            # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º SSL —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—ã, –µ—Å–ª–∏ –∏—Ö –Ω–µ—Ç
            if [ ! -f nginx/ssl/cert.pem ]; then
              echo "üîê Generating SSL certificates..."
              mkdir -p nginx/ssl
              cd nginx
              chmod +x generate-ssl.sh
              ./generate-ssl.sh
              cd ..
            fi
            
            # –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å—Ç–∞—Ä—ã–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã (–µ—Å–ª–∏ –µ—Å—Ç—å)
            echo "üõë Stopping old containers..."
            docker-compose down || true
            
            # –Ø–≤–Ω–æ —É–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–π nginx –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä (–∫–ª–∞—Å—Å–∏–∫–∞ –¥–µ–ø–ª–æ—è!)
            echo "üîç Removing old nginx container..."
            docker rm -f izborator_nginx || true
            
            # –£–¥–∞–ª—è–µ–º –ª—é–±—ã–µ –¥—Ä—É–≥–∏–µ nginx –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã
            docker ps -a --filter "name=nginx" --format "{{.ID}}" | xargs -r docker rm -f || true
            
            # –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–∏—Å—Ç–µ–º–Ω—ã–π Nginx (–µ—Å–ª–∏ –∑–∞–ø—É—â–µ–Ω), —á—Ç–æ–±—ã –æ—Å–≤–æ–±–æ–¥–∏—Ç—å –ø–æ—Ä—Ç—ã 80/443
            echo "üîç Checking system nginx..."
            if systemctl is-active --quiet nginx 2>/dev/null; then
              echo "‚ö†Ô∏è  System nginx is running, stopping it..."
              systemctl stop nginx || true
              systemctl disable nginx || true
              echo "‚úÖ System nginx stopped"
            fi
            
            # –£–±–∏–≤–∞–µ–º –∑–∞–≤–∏—Å—à–∏–µ docker-proxy –ø—Ä–æ—Ü–µ—Å—Å—ã (–æ–Ω–∏ –º–æ–≥—É—Ç –∑–∞–Ω–∏–º–∞—Ç—å –ø–æ—Ä—Ç—ã)
            echo "üîç Killing stale docker-proxy processes..."
            pkill -f "docker-proxy.*:443" || true
            pkill -f "docker-proxy.*:80" || true
            sleep 1
            
            # –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã, –∫–æ—Ç–æ—Ä—ã–µ –º–æ–≥—É—Ç –∑–∞–Ω–∏–º–∞—Ç—å –ø–æ—Ä—Ç—ã 80/443
            echo "üîç Checking for containers using ports 80/443..."
            # –ù–∞—Ö–æ–¥–∏–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã —á–µ—Ä–µ–∑ docker ps –∏ –ø—Ä–æ–≤–µ—Ä—è–µ–º –∏—Ö –ø–æ—Ä—Ç—ã
            docker ps --format "{{.ID}}\t{{.Ports}}" | while read -r container_id ports; do
              if echo "$ports" | grep -qE ":(80|443)->"; then
                echo "Stopping container $container_id using ports 80/443..."
                docker stop "$container_id" 2>/dev/null || true
                docker rm "$container_id" 2>/dev/null || true
              fi
            done
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–∏—Å—Ç–µ–º–Ω—ã–µ –ø—Ä–æ—Ü–µ—Å—Å—ã, –∑–∞–Ω–∏–º–∞—é—â–∏–µ –ø–æ—Ä—Ç—ã (–µ—Å–ª–∏ –¥–æ—Å—Ç—É–ø–Ω–æ)
            echo "üîç Checking system processes using ports 80/443..."
            for port in 80 443; do
              # –ü—Ä–æ–≤–µ—Ä—è–µ–º —á–µ—Ä–µ–∑ ss
              if command -v ss >/dev/null 2>&1 && ss -tln | grep -q ":$port "; then
                echo "‚ö†Ô∏è  Port $port is still in use!"
                # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º, —á—Ç–æ –∑–∞–Ω–∏–º–∞–µ—Ç –ø–æ—Ä—Ç
                ss -tlnp | grep ":$port " || true
                
                # –ü—ã—Ç–∞–µ–º—Å—è –Ω–∞–π—Ç–∏ –∏ —É–±–∏—Ç—å –ø—Ä–æ—Ü–µ—Å—Å —á–µ—Ä–µ–∑ fuser (–µ—Å–ª–∏ –¥–æ—Å—Ç—É–ø–Ω–æ)
                if command -v fuser >/dev/null 2>&1; then
                  echo "Killing process using port $port..."
                  fuser -k ${port}/tcp 2>/dev/null || true
                fi
                
                # –ü—ã—Ç–∞–µ–º—Å—è –Ω–∞–π—Ç–∏ PID —á–µ—Ä–µ–∑ lsof –∏ —É–±–∏—Ç—å
                if command -v lsof >/dev/null 2>&1; then
                  pid=$(lsof -ti :$port 2>/dev/null | head -1)
                  if [ ! -z "$pid" ]; then
                    echo "Killing process $pid using port $port..."
                    kill -9 "$pid" 2>/dev/null || true
                  fi
                fi
                
                # –ü—ã—Ç–∞–µ–º—Å—è –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Å–∏—Å—Ç–µ–º–Ω—ã–π nginx/apache (–µ—Å–ª–∏ –µ—Å—Ç—å)
                if systemctl is-active --quiet nginx 2>/dev/null; then
                  echo "‚ö†Ô∏è  System nginx is running, stopping it..."
                  systemctl stop nginx || true
                  systemctl disable nginx || true
                fi
                if systemctl is-active --quiet apache2 2>/dev/null; then
                  echo "‚ö†Ô∏è  System apache2 is running, stopping it..."
                  systemctl stop apache2 || true
                  systemctl disable apache2 || true
                fi
                
                # –ñ–¥–µ–º –Ω–µ–º–Ω–æ–≥–æ, —á—Ç–æ–±—ã –ø–æ—Ä—Ç –æ—Å–≤–æ–±–æ–¥–∏–ª—Å—è
                sleep 2
              fi
            done
            
            # –ü–µ—Ä–µ—Å–æ–±–∏—Ä–∞–µ–º –∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã
            echo "üî® Building and restarting containers..."
            docker-compose build 2>&1 | tail -50
            echo ""
            echo "üîÑ Starting containers..."
            docker-compose up -d
            echo ""
            echo "‚è≥ Waiting 5 seconds for containers to initialize..."
            sleep 5
            echo ""
            echo "üìã Container status after start:"
            docker-compose ps
            
            # –ñ–¥–µ–º –∑–∞–ø—É—Å–∫–∞ —Å–µ—Ä–≤–∏—Å–æ–≤ (—É–≤–µ–ª–∏—á–∏–≤–∞–µ–º –≤—Ä–µ–º—è –¥–ª—è health checks)
            echo "‚è≥ Waiting for services to start..."
            sleep 20
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å
            echo "‚úÖ Checking services status..."
            docker-compose ps
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å –≤—Å–µ—Ö –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤
            echo "üîç Checking container status..."
            docker-compose ps
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ backend –∑–∞–ø—É—â–µ–Ω
            echo "üìã Checking backend container status..."
            docker-compose ps backend
            echo ""
            
            if ! docker-compose ps | grep -q "backend.*Up"; then
              echo "‚ùå Backend container is not running!"
              echo ""
              echo "üìã Backend container logs (last 200 lines):"
              docker-compose logs --tail=200 backend || echo "No logs available"
              echo ""
              echo "üìã Checking if container exists..."
              docker ps -a | grep backend || echo "Backend container not found"
              echo ""
              echo "üìã Trying to start backend manually to see error..."
              docker-compose up backend 2>&1 | head -50 || true
              echo ""
              echo "üìã Checking backend image..."
              docker images | grep izborator_backend || echo "Backend image not found"
              exit 1
            fi
            
            # –î–∞–µ–º Go-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏—é –≤—Ä–µ–º—è –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ –ë–î
            echo "‚è≥ Waiting for backend to start (10s)..."
            sleep 10
            
            # –ñ–¥–µ–º, –ø–æ–∫–∞ backend —Å—Ç–∞–Ω–µ—Ç healthy (–º–∞–∫—Å–∏–º—É–º 60 —Å–µ–∫—É–Ω–¥)
            echo "‚è≥ Waiting for backend to become healthy..."
            for i in {1..12}; do
              if docker-compose ps | grep -q "backend.*healthy"; then
                echo "‚úÖ Backend is healthy!"
                break
              fi
              echo "Waiting... ($i/12)"
              sleep 5
            done
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º health —á–µ—Ä–µ–∑ backend –Ω–∞–ø—Ä—è–º—É—é (–≤–Ω—É—Ç—Ä–∏ Docker network)
            # –ò—Å–ø–æ–ª—å–∑—É–µ–º GET –≤–º–µ—Å—Ç–æ HEAD (wget --spider –∏—Å–ø–æ–ª—å–∑—É–µ—Ç HEAD, –∫–æ—Ç–æ—Ä—ã–π –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è)
            echo "üè• Checking Health on port 8080..."
            health_output=$(docker exec izborator_backend wget -q -O- http://localhost:8080/api/health 2>&1 || echo "failed")
            if echo "$health_output" | grep -q "ok"; then
              echo "‚úÖ Backend is healthy!"
            else
              echo "‚ö†Ô∏è  Health check returned: $health_output"
              echo "üìã Fetching backend logs..."
              docker-compose logs --tail=100 backend
              echo "üìã Checking backend container status..."
              docker-compose ps backend
              echo "üìã Checking if backend is running..."
              if docker ps | grep -q izborator_backend; then
                echo "‚ö†Ô∏è  Backend container is running but health check failed. Continuing..."
              else
                echo "‚ùå Backend container is not running! Deployment failed."
                exit 1
              fi
            fi
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º health —á–µ—Ä–µ–∑ nginx (–ø–æ—Ä—Ç 80)
            echo "üè• Health check (via nginx on port 80)..."
            if curl -f http://localhost/api/health 2>&1; then
              echo "‚úÖ Nginx health check passed"
            else
              echo "‚ö†Ô∏è  Nginx health check failed, showing logs..."
              docker-compose logs --tail=50 nginx
              docker-compose logs --tail=50 backend
              # –ù–µ –ø–∞–¥–∞–µ–º, –µ—Å–ª–∏ nginx –µ—â–µ –Ω–µ –≥–æ—Ç–æ–≤, –Ω–æ backend —Ä–∞–±–æ—Ç–∞–µ—Ç
              echo "‚ö†Ô∏è  Continuing despite nginx check failure (backend is healthy)"
            fi
            
            echo "üéâ Deployment completed successfully!"
            
            # –ï—Å–ª–∏ –±—ã–ª–∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ classifier –∫–æ–¥–µ, –ø–µ—Ä–µ—Å–æ–±–∏—Ä–∞–µ–º –∏ –∑–∞–ø—É—Å–∫–∞–µ–º Classifier
            if git diff HEAD~1 HEAD --name-only | grep -qE "(classifier_adapter|classifier/main)"; then
              echo ""
              echo "üîç –û–±–Ω–∞—Ä—É–∂–µ–Ω—ã –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ Classifier - –ø–µ—Ä–µ—Å–æ–±–∏—Ä–∞–µ–º –∏ –∑–∞–ø—É—Å–∫–∞–µ–º..."
              docker-compose build backend
              docker-compose up -d
              sleep 10
              
              echo "üîç –ó–∞–ø—É—Å–∫ Classifier..."
              docker-compose run --rm backend ./classifier -classify-all || echo "‚ö†Ô∏è  Classifier –∑–∞–≤–µ—Ä—à–∏–ª—Å—è —Å –æ—à–∏–±–∫–∞–º–∏"
              echo ""
              
              echo "üìä –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤..."
              bash check-pipeline-results.sh || true
            fi
          EOF

      - name: Notify deployment status
        if: always()
        run: |
          if [ "${{ job.status }}" == "success" ]; then
            echo "‚úÖ Deployment successful!"
          else
            echo "‚ùå Deployment failed!"
          fi

