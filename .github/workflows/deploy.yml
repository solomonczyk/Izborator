name: Deploy to Production

on:
  push:
    branches:
      - main
  workflow_dispatch: # –ü–æ–∑–≤–æ–ª—è–µ—Ç –∑–∞–ø—É—Å–∫–∞—Ç—å –≤—Ä—É—á–Ω—É—é

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}
        
      - name: Verify SSH key is set
        if: env.SSH_PRIVATE_KEY == ''
        run: |
          echo "‚ùå Error: SSH_PRIVATE_KEY secret is not configured!"
          echo "Please add SSH_PRIVATE_KEY secret in GitHub Settings ‚Üí Secrets and variables ‚Üí Actions"
          exit 1
        env:
          SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: Add server to known hosts
        run: |
          ssh-keyscan -H ${{ secrets.SERVER_HOST }} >> ~/.ssh/known_hosts

      - name: Deploy to server
        run: |
          ssh root@${{ secrets.SERVER_HOST }} << 'EOF'
            set -e
            cd ~/Izborator
            
            # –û–±–Ω–æ–≤–ª—è–µ–º –∫–æ–¥ (—Å–±—Ä–∞—Å—ã–≤–∞–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è)
            echo "üì• Pulling latest changes..."
            git fetch origin
            git reset --hard origin/main
            git clean -fd
            
            # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º SSL —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—ã, –µ—Å–ª–∏ –∏—Ö –Ω–µ—Ç
            if [ ! -f nginx/ssl/cert.pem ]; then
              echo "üîê Generating SSL certificates..."
              mkdir -p nginx/ssl
              cd nginx
              chmod +x generate-ssl.sh
              ./generate-ssl.sh
              cd ..
            fi
            
            # –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å—Ç–∞—Ä—ã–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã (–µ—Å–ª–∏ –µ—Å—Ç—å)
            echo "üõë Stopping old containers..."
            docker-compose down || true
            
            # –Ø–≤–Ω–æ —É–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–π nginx –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä (–∫–ª–∞—Å—Å–∏–∫–∞ –¥–µ–ø–ª–æ—è!)
            echo "üîç Removing old nginx container..."
            docker rm -f izborator_nginx || true
            
            # –£–¥–∞–ª—è–µ–º –ª—é–±—ã–µ –¥—Ä—É–≥–∏–µ nginx –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã
            docker ps -a --filter "name=nginx" --format "{{.ID}}" | xargs -r docker rm -f || true
            
            # –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã, –∫–æ—Ç–æ—Ä—ã–µ –º–æ–≥—É—Ç –∑–∞–Ω–∏–º–∞—Ç—å –ø–æ—Ä—Ç—ã 80/443
            echo "üîç Checking for containers using ports 80/443..."
            # –ù–∞—Ö–æ–¥–∏–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã —á–µ—Ä–µ–∑ docker ps –∏ –ø—Ä–æ–≤–µ—Ä—è–µ–º –∏—Ö –ø–æ—Ä—Ç—ã
            docker ps --format "{{.ID}}\t{{.Ports}}" | while read -r container_id ports; do
              if echo "$ports" | grep -qE ":(80|443)->"; then
                echo "Stopping container $container_id using ports 80/443..."
                docker stop "$container_id" 2>/dev/null || true
                docker rm "$container_id" 2>/dev/null || true
              fi
            done
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º —á–µ—Ä–µ–∑ ss, —á—Ç–æ –∑–∞–Ω–∏–º–∞–µ—Ç –ø–æ—Ä—Ç—ã (–µ—Å–ª–∏ –¥–æ—Å—Ç—É–ø–Ω–æ)
            if command -v ss >/dev/null 2>&1; then
              for port in 80 443; do
                if ss -tln | grep -q ":$port "; then
                  echo "‚ö†Ô∏è  Port $port is still in use, trying to find and stop the process..."
                  # –ü—ã—Ç–∞–µ–º—Å—è –Ω–∞–π—Ç–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä —á–µ—Ä–µ–∑ inspect
                  for container in $(docker ps --format "{{.ID}}"); do
                    if docker port "$container" 2>/dev/null | grep -q ":$port"; then
                      echo "Found container $container using port $port, stopping..."
                      docker stop "$container" 2>/dev/null || true
                      docker rm "$container" 2>/dev/null || true
                    fi
                  done
                fi
              done
            fi
            
            # –ü–µ—Ä–µ—Å–æ–±–∏—Ä–∞–µ–º –∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã
            echo "üî® Building and restarting containers..."
            docker-compose build
            docker-compose up -d
            
            # –ñ–¥–µ–º –∑–∞–ø—É—Å–∫–∞ —Å–µ—Ä–≤–∏—Å–æ–≤
            echo "‚è≥ Waiting for services to start..."
            sleep 10
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å
            echo "‚úÖ Checking services status..."
            docker-compose ps
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º health
            echo "üè• Health check..."
            curl -f http://localhost/api/health || exit 1
            
            echo "üéâ Deployment completed successfully!"
          EOF

      - name: Notify deployment status
        if: always()
        run: |
          if [ "${{ job.status }}" == "success" ]; then
            echo "‚úÖ Deployment successful!"
          else
            echo "‚ùå Deployment failed!"
          fi

