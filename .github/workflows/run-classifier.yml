name: Run Classifier

on:
  workflow_dispatch:
  push:
    branches:
      - main
    paths:
      - '.github/workflows/run-classifier.yml'
      - '.trigger-classifier'

jobs:
  classifier:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}
        
      - name: Add server to known hosts
        run: |
          ssh-keyscan -H ${{ secrets.SERVER_HOST }} >> ~/.ssh/known_hosts

      - name: Run Classifier
        run: |
          ssh root@${{ secrets.SERVER_HOST }} << 'EOF'
            set -e
            cd ~/Izborator
            
            echo "üîç –ó–∞–ø—É—Å–∫ Classifier..."
            echo ""
            
            # –ó–∞–≥—Ä—É–∂–∞–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –∏–∑ .env
            if [ -f .env ]; then
              export $(cat .env | grep -v '^#' | xargs)
              echo "‚úÖ –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è –∑–∞–≥—Ä—É–∂–µ–Ω—ã"
            else
              echo "‚ö†Ô∏è  –§–∞–π–ª .env –Ω–µ –Ω–∞–π–¥–µ–Ω"
            fi
            echo ""
            
            # –ó–∞–ø—É—Å–∫–∞–µ–º Classifier
            echo "üöÄ –ó–∞–ø—É—Å–∫: ./classifier -classify-all"
            docker-compose run --rm backend ./classifier -classify-all 2>&1 | tee /tmp/classifier.log
            echo ""
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
            echo "üìä –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ—Å–ª–µ Classifier:"
            docker-compose exec -T postgres psql -U postgres -d izborator -c "
              SELECT 
                  status,
                  COUNT(*) as count
              FROM potential_shops
              GROUP BY status
              ORDER BY status;
            "
            echo ""
            
            # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–µ –ª–æ–≥–∏
            echo "üìù –ü–æ—Å–ª–µ–¥–Ω–∏–µ 20 —Å—Ç—Ä–æ–∫ –ª–æ–≥–æ–≤:"
            tail -20 /tmp/classifier.log || echo "–õ–æ–≥–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã"
            echo ""
            
            echo "‚úÖ Classifier –∑–∞–≤–µ—Ä—à–µ–Ω"
          EOF

