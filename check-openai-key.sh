#!/bin/bash
# –°–∫—Ä–∏–ø—Ç –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ OpenAI API –∫–ª—é—á–∞

set -e

cd ~/Izborator

echo "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ OpenAI API –∫–ª—é—á–∞..."
echo "=========================================="

# –ó–∞–≥—Ä—É–∂–∞–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –∏–∑ .env
if [ -f .env ]; then
  export $(cat .env | grep -v '^#' | xargs)
else
  echo "‚ùå –§–∞–π–ª .env –Ω–µ –Ω–∞–π–¥–µ–Ω!"
  exit 1
fi

if [ -z "$OPENAI_API_KEY" ]; then
  echo "‚ùå OPENAI_API_KEY –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ .env"
  exit 1
fi

# –£–¥–∞–ª—è–µ–º –ø—Ä–æ–±–µ–ª—ã –∏ –ø–µ—Ä–µ–Ω–æ—Å—ã —Å—Ç—Ä–æ–∫
CLEAN_KEY=$(echo "$OPENAI_API_KEY" | tr -d '[:space:]')

echo "üìã –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∫–ª—é—á–µ:"
echo "   –ù–∞—á–∏–Ω–∞–µ—Ç—Å—è —Å: ${CLEAN_KEY:0:10}..."
echo "   –ó–∞–∫–∞–Ω—á–∏–≤–∞–µ—Ç—Å—è –Ω–∞: ...${CLEAN_KEY: -4}"
echo "   –î–ª–∏–Ω–∞: ${#CLEAN_KEY} —Å–∏–º–≤–æ–ª–æ–≤"
echo ""

# –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ñ–æ—Ä–º–∞—Ç
if [[ ! "$CLEAN_KEY" =~ ^sk- ]]; then
  echo "‚ö†Ô∏è  –ö–ª—é—á –Ω–µ –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è —Å 'sk-' - –≤–æ–∑–º–æ–∂–Ω–æ, –Ω–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç"
fi

# –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–ª–∏–Ω—É (–æ–±—ã—á–Ω–æ 50+ —Å–∏–º–≤–æ–ª–æ–≤)
if [ ${#CLEAN_KEY} -lt 40 ]; then
  echo "‚ö†Ô∏è  –ö–ª—é—á —Å–ª–∏—à–∫–æ–º –∫–æ—Ä–æ—Ç–∫–∏–π (${#CLEAN_KEY} —Å–∏–º–≤–æ–ª–æ–≤) - –≤–æ–∑–º–æ–∂–Ω–æ, –Ω–µ–ø–æ–ª–Ω—ã–π"
fi

echo ""
echo "üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–ª—é—á–∞ —á–µ—Ä–µ–∑ OpenAI API..."
echo ""

# –¢–µ—Å—Ç–∏—Ä—É–µ–º –∫–ª—é—á —á–µ—Ä–µ–∑ –ø—Ä–æ—Å—Ç–æ–π –∑–∞–ø—Ä–æ—Å
RESPONSE=$(curl -s -w "\n%{http_code}" \
  -H "Authorization: Bearer $CLEAN_KEY" \
  -H "Content-Type: application/json" \
  https://api.openai.com/v1/models 2>&1)

HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
BODY=$(echo "$RESPONSE" | sed '$d')

if [ "$HTTP_CODE" = "200" ]; then
  echo "‚úÖ –ö–ª—é—á –≤–∞–ª–∏–¥–µ–Ω! API –æ—Ç–≤–µ—á–∞–µ—Ç —É—Å–ø–µ—à–Ω–æ"
  echo ""
  echo "üìä –î–æ—Å—Ç—É–ø–Ω—ã–µ –º–æ–¥–µ–ª–∏ (–ø–µ—Ä–≤—ã–µ 5):"
  echo "$BODY" | grep -o '"id":"[^"]*"' | head -5 | sed 's/"id":"//g' | sed 's/"//g' | sed 's/^/   - /'
elif [ "$HTTP_CODE" = "401" ]; then
  echo "‚ùå –û—à–∏–±–∫–∞ 401: –ö–ª—é—á –Ω–µ–≤–µ—Ä–Ω—ã–π –∏–ª–∏ –∏—Å—Ç–µ–∫"
  echo ""
  echo "üîß –†–µ—à–µ–Ω–∏–µ:"
  echo "   1. –ü–µ—Ä–µ–π–¥–∏ –Ω–∞ https://platform.openai.com/account/api-keys"
  echo "   2. –°–æ–∑–¥–∞–π –Ω–æ–≤—ã–π –∫–ª—é—á (Create new secret key)"
  echo "   3. –°–∫–æ–ø–∏—Ä—É–π –∫–ª—é—á –ø–æ–ª–Ω–æ—Å—Ç—å—é (–±–µ–∑ –ø—Ä–æ–±–µ–ª–æ–≤)"
  echo "   4. –û–±–Ω–æ–≤–∏ .env: nano .env"
  echo "   5. –ó–∞–º–µ–Ω–∏ OPENAI_API_KEY –Ω–∞ –Ω–æ–≤—ã–π –∫–ª—é—á"
  echo "   6. –°–æ—Ö—Ä–∞–Ω–∏ —Ñ–∞–π–ª –∏ –∑–∞–ø—É—Å—Ç–∏ —ç—Ç–æ—Ç —Å–∫—Ä–∏–ø—Ç —Å–Ω–æ–≤–∞"
elif [ "$HTTP_CODE" = "429" ]; then
  echo "‚ö†Ô∏è  –û—à–∏–±–∫–∞ 429: –ü—Ä–µ–≤—ã—à–µ–Ω rate limit"
  echo "   –ü–æ–¥–æ–∂–¥–∏ –Ω–µ—Å–∫–æ–ª—å–∫–æ –º–∏–Ω—É—Ç –∏ –ø–æ–ø—Ä–æ–±—É–π —Å–Ω–æ–≤–∞"
else
  echo "‚ö†Ô∏è  –ù–µ–æ–∂–∏–¥–∞–Ω–Ω—ã–π –æ—Ç–≤–µ—Ç: HTTP $HTTP_CODE"
  echo "   –û—Ç–≤–µ—Ç: $BODY"
fi

echo ""

