# ???????? 1 ? ????????????? ????, pipeline, ???????? (Data Packet)

**????:** 2026-01-01  
**??????????:** ????????????? ??????? ????????? ?????????????? ????, ????????? discovery/???????? ? ????????? ???????? ??? ???????? ? ????? ?????????.

---

## 1. ????? ?????? / ????????? (????? ??????)

### ??? ????????????? ????????????? ????
- `backend/migrations/0005_catalog_core.up.sql` ? ??????? `categories`, `product_types`, `attributes`, `cities` ? ????? ????? ????.
- `backend/internal/categories/*`, `backend/internal/cities/*`, `backend/internal/products/*` ? ???????? ??????, ??????? ???????? ? ?????.
- API, ??????????? ?? ????: `/api/v1/categories/tree`, `/api/v1/cities`, `/api/v1/products/browse`.

### ???????? ???????? (??????)
| ???????? | ?????????? | ??????? ???? | ??????????? ???? | ??????????? |
|---|---|---|---|---|
| `categories` | ???????? ????????? | `slug`, `code`, `name_sr`, `level` | ? | ????????????? ?????????????, ?? ????????? ? ????????? |
| `product_types` | ???? ???????? ?????? ????????? | `code`, `name_sr` | ? | ???????????? ??? ???????/????? |
| `attributes` | ?????????? ????????? | `code`, `name_sr`, `data_type` | `unit_sr`, `is_filterable`, `is_sortable` | ??????????? ?????????? ???? |
| `cities` | ????????? | `slug`, `name_sr` | `region_sr` | ????????????? ???-??? |
| `shops` | ????????? ?????? | `name`, `base_url` | `selectors` (JSONB), `rate_limit`, `discovery_source` | ?????? ???????? ???????? ????? JSONB |
| `raw_products` | ????? ?????? | `name`, `price`, `url`, `shop_id` | `specs` (JSONB), `image_urls` (JSONB) | ?????? ? ?????????, ??????? ???????????? |
| `products` | ???????????? ???????? | `name` | `specs` (JSONB), `brand`, `category` | ??????????????? ???? |
| `product_prices` | ???? | `price`, `currency`, `product_id`, `shop_id` | `city_id` | ??????? ?????? ???? |
| `potential_shops` | ????????? discovery | `domain`, `status` | `metadata` (JSONB) | ???? discovery-????????? |
| `shop_config_attempts` | AI-?????? ??????? | `status` | `ai_response` (JSONB), `validation_result` (JSONB) | ??????? ??????????? |
| `scraping_stats` | ??????? ???????? | `status`, `products_found`, `products_saved` | `error_message`, `duration_ms` | ???????? ? ?????????? ????????? |

### ??? ?????????? ???????? ?????????
- ??????? `products` ? `product_prices` ????????????, ??? ? ??????? ???? **????** ? **??????**. ??? ????? ??? ????? ???? ???????? fit (????????, "??", "?? ???").
- ? `raw_products` ? `products` ???? `brand` ? `category` ??????? ? ??? ??????????? goods-??????????????? ??????.
- UI ?????? ???????? ?? `category` ? `slug` (????????? ?????????).

### ??????? ? ??????????? ????
- **??????? (????????????/?????????):**
  - `products.name`, `product_prices.price`, `product_prices.currency`, `raw_products.name`, `shops.base_url`, `categories.slug`.
- **???????????:**
  - JSONB ????: `shops.selectors`, `raw_products.specs`, `raw_products.image_urls`, `potential_shops.metadata`, `shop_config_attempts.ai_response`, `shop_config_attempts.validation_result`.
  - ????? ?????????? `attributes` ? ????? `product_type_attributes` ????? ???????? ????? ??????? ??? ????????.

### ????? ??? ???????????????
- ????????????? ???? ?????????? ? ????????????? (?????????/????/????????/??????).
- ???? **???????????? seed/???????? ??????**, ??????? ????????? ???????? ???????? (??. `backend/scripts/seed_test_products.sql`).

---

## 2. Discovery / parsing pipeline (??????, ?? ???)

### ????? (ingest ? parse ? normalize ? validate ? index)
1. **Discovery (ingest):** ????? ??????? ? ?????? ? `potential_shops` ?? ???????? `new`.
2. **Classifier (normalize/triage):** ????????????? ??????? ? `classified` / `rejected`.
3. **AutoConfig (parse setup):** ????????? ?????????? ? ??????? ????????? ? `shops`, `shop_config_attempts`.
4. **Worker Discover (ingest urls):** ????? URL/????????? ?? ?????????.
5. **Worker Process (parse/normalize):** ??????? URL ? `raw_products` ? ???????????? ? `products` + `product_prices`.
6. **Index:** ?????? ? Meilisearch ??? ?????? ? /browse.

### ?????????
```
for domain in discovery():
  potential_shops.add(domain, status="new")

for candidate in potential_shops where status="new":
  classify(candidate) -> status

for candidate in potential_shops where status="classified":
  selectors = autoconfig(candidate)
  shops.add(selectors)

for shop in shops where enabled:
  urls = discover_catalog_urls(shop)
  for url in urls:
    raw = scrape(url)
    normalized = normalize(raw)
    if validate(normalized):
      upsert products, product_prices
      index in Meilisearch
    else:
      log error
```

### ??? ????????? ???????
- `scraping_stats` ? ??????? ?? ???????? (status, products_found, products_saved, errors_count, duration_ms).
- `shop_config_attempts` ? ?????????? ???????? AI-??????? (success/failed).

### ??? ???????? ?????????-????????? ??????
- ????????????? (???????? ????? ??? services vs goods).
- AutoConfig (?????????? ? ????????? ????? ???? goods-?????????????).
- UI (?????? ? ??????? ?? `category` ???????).

---

## 3. ??????? ???????? ???????? ? ????????

### ??? ?????? ????????? ????????? ??????????
- ?? ?????? ???????? ??????????? ??????? **name** ? **price > 0** (??. ?????? ? `docs/development/DEVELOPMENT_LOG.md` ? "failed to extract essential data").
- ? AutoConfig ????? = ?????? ? `shop_config_attempts` ?? ???????? `success`.

### ??????? ???????? / ???-?????
- API browse ????????: `docs/development/TEST_SERVER_API.md`, `docs/development/ROADMAP_CURRENT_STEP.md`.
- E2E ???????? `/browse`: `docs/development/E2E_TEST_CHECKLIST.md`.
- CI:
  - `.github/workflows/check-logs.yml` ? health + GET /products/{id} + Meilisearch stats.
  - `.github/workflows/test-product-api.yml` ? ???????? `/api/health` ? ???????? ?? id.
  - `.github/workflows/code-quality.yml` ? ????/??????????? ????????.

### ??? ???????? ??? ??????????? (????)
- ? UI ???? ????????? ? ?????? ?? ???????????/??????? (slug/category string match).
- Seed-?????? ? `backend/scripts/seed_test_products.sql` ?????????? ??????????? (Samsung/Lenovo).

### ??? ??? ???????? ??????
- ??? CI-???????? ?? **???????? ??????** (????????? ????/???????? seed-??????).
- ??? ?????? ?? ?????????? (??????/??????/??????).
- ??? ????? ?? "service" ??? ???????????? ???? (???? ?????? ?? ????? ????????????? ????).

---

## 4. ????????? ??????????? (??? ????)

```
Izborator/
  backend/
    cmd/
    internal/
    migrations/
    scripts/
  frontend/
    app/
    components/
    lib/
    public/
  docs/
    architecture/
    deployment/
    development/
    guides/
    testing/
  scripts/
  nginx/
  .github/
    workflows/
  docker-compose.yml
  README.md
```

??????? ???????:
- `backend/internal/*` ? ???????? ??????.
- `backend/cmd/*` ? ??????? ????? (API, worker, discovery, classifier, autoconfig).
- `frontend/app` ? `frontend/components` ? UI ? SSR.

---

## 5. UI / filters logic (????????)

### ??? ???????? ???????
- ???????? ????????: `frontend/app/[locale]/catalog/page.tsx`.
- ????????? ???????: `q`, `category`, `city`, `type`, `min_price`, `max_price`, `sort`, `per_page`.
- ??? ????????? ???????? ????????????? ? `/api/v1/products/browse`.

### ?????? ??????? ?????? ????????
- ?????????: `fetchCategoriesTree()` ? `/api/v1/categories/tree` (`frontend/lib/api.ts`).
- ??????: `fetchCities()` ? `/api/v1/cities` (`frontend/lib/api.ts`).
- ??? (good/service) ? ????????????? ????? ????? ? UI.

### ??? ???????
- `frontend/app/[locale]/page.tsx`: ?????? ????????? ?? slug/????? (string match).
- `frontend/components/product-card.tsx`: ?????? ????? ?? `category` (string match).

### ?????
- UI-?????? ?????? ? ????? UX ???????? ?? ????????? ????????? ? ????? ???? ???????????-???????????.
- `service_metadata` ???????????? ? UI, ?? ?? ?????????? ? ????? ?? ??? ???????????? ????.

---

## ??? ?? ???????? (?? ???????)
- ?????????? ?????????? ????????.
- ?????? ????? ?????????.
- ???? ??? ?????????.
